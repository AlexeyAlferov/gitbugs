-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** MODEL_FLOW_CONTROL_DISPOSAL
CREATE VIEW MODEL_FLOW_CONTROL_DISPOSAL AS
  --STATE-specific flow controls
WITH STATE_FLOW_CONTROL AS
 (SELECT * FROM EXPLODED_FLOW_CONTROL
 WHERE RULE_DEST = 'State'),

 --COUNTY-specific flow controls
 COUNTY_FLOW_CONTROL AS
 (SELECT * FROM EXPLODED_FLOW_CONTROL
 WHERE RULE_DEST = 'County'),

 --CITY-specific flow controls
CITY_FLOW_CONTROL AS
 (SELECT * FROM EXPLODED_FLOW_CONTROL
 WHERE RULE_DEST = 'City'),

 --SITE-specific flow controls
SITE_FLOW_CONTROL AS
 (SELECT * FROM EXPLODED_FLOW_CONTROL
 WHERE RULE_DEST = 'Disposal Site'),

 --Get all disposal facilities in the model
 MODEL_DISPOSAL_FACILITIES_MAT_GEO AS
 (
 SELECT
 fac.FAC_ID,
 facm.WASTE_TYPE,
 fac.GEO_CITY_NM,
 fac.GEO_COUNTY_NM,
 fac.GEO_STATE_CD
 FROM MODEL_FACILITIES_MATERIAL facm
 INNER join MODEL_FACILITIES fac ON fac.FAC_ID = facm.FAC_ID AND fac.status_ind ='A'
 WHERE facm.ACCEPTED_FLAG!='N'
 ),

 --Create the table for all county-sourced flow controls and associated disposal points
FLOW_CONTROL_STATE_DISPOSAL AS
(SELECT
    fac.FAC_ID
    ,fc.FC_RULE_NUMBER
    ,fc.WASTE_TYPE AS FC_WASTE_TYPE
FROM STATE_FLOW_CONTROL fc
INNER JOIN MODEL_DISPOSAL_FACILITIES_MAT_GEO fac ON UPPER(fac.GEO_STATE_CD)=UPPER(fc.DEST_STATE_CD)
WHERE (fc.WASTE_TYPE=fac.WASTE_TYPE) or (UPPER(fc.WASTE_TYPE)='ALL')),

--Create the table for all county-sourced flow controls and associated disposal points
FLOW_CONTROL_COUNTY_DISPOSAL AS
(SELECT
    fac.FAC_ID
    ,fc.FC_RULE_NUMBER
    ,fc.WASTE_TYPE AS FC_WASTE_TYPE
FROM COUNTY_FLOW_CONTROL fc
INNER JOIN MODEL_DISPOSAL_FACILITIES_MAT_GEO fac ON UPPER(FAC.GEO_STATE_CD||'-'||FAC.GEO_COUNTY_NM) = UPPER(FC.DEST_STATE_CD||'-'||FC.DEST_COUNTY_NM)
WHERE (fc.WASTE_TYPE=fac.WASTE_TYPE) or (UPPER(fc.WASTE_TYPE)='ALL')),

--Create the table for all city-souced flow controls and associated disposal points
FLOW_CONTROL_CITY_DISPOSAL AS
(SELECT
    fac.FAC_ID
    ,fc.FC_RULE_NUMBER
    ,fc.WASTE_TYPE AS FC_WASTE_TYPE
FROM CITY_FLOW_CONTROL fc
INNER JOIN MODEL_DISPOSAL_FACILITIES_MAT_GEO fac ON UPPER(FAC.GEO_STATE_CD||'-'||FAC.GEO_CITY_NM) = UPPER(FC.DEST_STATE_CD||'-'||FC.DEST_CITY_NM)
WHERE (fc.WASTE_TYPE=fac.WASTE_TYPE) or (UPPER(fc.WASTE_TYPE)='ALL')),

--Create the table for all site-sourced flow controls and associated disposal points
FLOW_CONTROL_SITE_DISPOSAL AS
(SELECT
    fac.FAC_ID
    ,fc.FC_RULE_NUMBER
    ,fc.WASTE_TYPE AS FC_WASTE_TYPE
FROM SITE_FLOW_CONTROL fc
INNER JOIN MODEL_DISPOSAL_FACILITIES_MAT_GEO fac ON fac.FAC_ID=fc.DEST_DISPOSAL_SITE_ID
WHERE (fc.WASTE_TYPE=fac.WASTE_TYPE) or (UPPER(fc.WASTE_TYPE)='ALL'))

--Create final view
SELECT
    FC_RULE_NUMBER
    ,FAC_ID AS DISP_FAC_ID
FROM FLOW_CONTROL_COUNTY_DISPOSAL
UNION
SELECT
    FC_RULE_NUMBER
    ,FAC_ID AS DISP_FAC_ID
FROM FLOW_CONTROL_CITY_DISPOSAL
UNION
SELECT
    FC_RULE_NUMBER
    ,FAC_ID AS DISP_FAC_ID
FROM FLOW_CONTROL_SITE_DISPOSAL
UNION
SELECT
    FC_RULE_NUMBER
    ,FAC_ID AS DISP_FAC_ID
FROM FLOW_CONTROL_STATE_DISPOSAL
;
