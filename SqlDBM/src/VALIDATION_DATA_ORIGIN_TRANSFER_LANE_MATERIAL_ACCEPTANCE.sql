-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** VALIDATION_DATA_ORIGIN_TRANSFER_LANE_MATERIAL_ACCEPTANCE
CREATE VIEW VALIDATION_DATA_ORIGIN_TRANSFER_LANE_MATERIAL_ACCEPTANCE AS
--
--  To ensure that every WM transfer station has at least one active lane for the waste types that it accepts (showstopper).
--  Get waste types associated with source transfer stations
--  and verify at least 1 active lane exists for this waste type
--
SELECT A.FAC_ID
   ,('WM-owned transfer station ' || A.FAC_ID || ' has no active outbound transfer lane for waste type ' ||C.WASTE_TYPE) AS DETAIL
   ,SUBSTR(A.FAC_ID,1,6) AS LH_PARM_1
   ,LH_FAC_TYPE(A.FAC_ID)  AS LH_PARM_2
   ,C.WASTE_TYPE AS LH_PARM_3
   ,NULL AS LH_PARM_4
   ,NULL AS LH_PARM_5
FROM MODEL_FACILITIES A
JOIN MODEL_FACILITIES_MATERIAL C ON A.FAC_ID = C.FAC_ID AND C.ACCEPTED_FLAG in ('Y', 'U')		-- Only if acceptance is Y or U
WHERE NOT EXISTS
(	SELECT 1 FROM MODEL_TRANSFER_COSTS B
	WHERE C.FAC_ID = B.LANE_ORIGIN_FAC_ID
    AND C.WASTE_TYPE = B.WASTE_TYPE
    AND B.STATUS_IND = 'A'					-- currently always 'A'
)
AND A.WM_OWNED_FLAG = 'Y'				    -- only interested in WM owned.
AND A.FAC_TYPE = 'TS'				        -- only interested in Transfer Lanes
;
