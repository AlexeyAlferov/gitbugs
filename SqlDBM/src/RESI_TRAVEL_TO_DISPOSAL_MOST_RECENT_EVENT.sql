-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** RESI_TRAVEL_TO_DISPOSAL_MOST_RECENT_EVENT
CREATE VIEW RESI_TRAVEL_TO_DISPOSAL_MOST_RECENT_EVENT as

SELECT * FROM

(SELECT FK_ROUTEORDER, LANDFILL_PKEY, ARRIVE, EVENT_BEFORE_LANDFILL, ROW_NUMBER () OVER(PARTITION BY LANDFILL_PKEY ORDER BY ARRIVE asc) RN 

FROM

(

SELECT ROL.FK_ROUTEORDER, ROL.PKEY LANDFILL_PKEY , ROL.ARRIVE  , max(EVENT_BEFORE_LANDFILL) EVENT_BEFORE_LANDFILL

FROM STG.TP_RO_LANDFILL  ROL

JOIN MART.RESI_POSSIBLE_ROUTE_EVENTS_BEFORE_LANDFILL EVNTS_BFR

ON EVNTS_BFR.fk_routeorder = ROL.FK_ROUTEORDER 

AND ROL.FK_VEHICLE IS NULL 

AND ROL.ARRIVE >= EVNTS_BFR.EVENT_BEFORE_LANDFILL

GROUP BY ROL.FK_ROUTEORDER, ROL.PKEY  , ROL.ARRIVE

) A

) A1

WHERE A1.RN=1 

;
