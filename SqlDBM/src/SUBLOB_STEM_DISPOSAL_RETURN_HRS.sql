-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** SUBLOB_STEM_DISPOSAL_RETURN_HRS
CREATE VIEW SUBLOB_STEM_DISPOSAL_RETURN_HRS AS

WITH good_routes AS (  -- those routes with enough consumer data

SELECT  -- can use directly aggregated STEM_DISPOSAL_RETURN_HRS

    rsdrh.HAULING_SITE

    ,rsdrh.SUBLOB

    ,SUM(TOTAL_HRS) AS RAW_STEM_DISPOSAL_RETURN_HRS,

    CASE WHEN RAW_STEM_DISPOSAL_RETURN_HRS < 0 THEN 0

    ELSE RAW_STEM_DISPOSAL_RETURN_HRS

    END AS STEM_DISPOSAL_RETURN_HRS

FROM ROUTE_STEM_DISPOSAL_RETURN_HRS rsdrh

    INNER JOIN good_routes_for_timing grft

        ON rsdrh.ro_key = grft.ro_key

        AND rsdrh.sublob = grft.sublob

        AND rsdrh.HAULING_SITE = grft.HAULING_SITE

        AND rsdrh.service_dt = grft.service_dt

WHERE rsdrh.service_dt BETWEEN $start_date AND $end_date

GROUP BY rsdrh.HAULING_SITE, rsdrh.SUBLOB

),

bad_routes AS (

SELECT  -- bad routes adjust total_hrs (defined as the latest event_end - the earliest event_start

    brft.HAULING_SITE  -- by pre-calculated % time taken using averages on good routes per sublob

    , brft.sublob

    , COALESCE(mgrdr.avg_pct_stem, 0.3) * COALESCE(SUM(trd.TOTAL_ROUTE_DURATION_HRS), 10) AS stem_disposal_return_hrs

FROM TOTAL_ROUTE_DURATION trd  -- NB. event_start filter already happened in TOTAL_ROUTE_DURATION

    RIGHT JOIN bad_routes_for_timing brft

        ON trd.ro_key = brft.ro_key

        AND trd.sublob = brft.sublob

        AND trd.HAULING_SITE = brft.HAULING_SITE

    INNER JOIN mean_good_route_disp_return mgrdr

        ON mgrdr.sublob = brft.sublob

GROUP BY brft.HAULING_SITE, brft.SUBLOB, mgrdr.avg_pct_stem

)

SELECT  -- add imputed bad rt hours to calculated good rt hours

    HAULING_SITE

    , sublob

    , SUM(stem_disposal_return_hrs) AS stem_disposal_return_hrs

FROM (

    SELECT HAULING_SITE, sublob, stem_disposal_return_hrs FROM good_routes

    UNION ALL

    SELECT * FROM bad_routes

) tbl

GROUP BY HAULING_SITE, sublob;
