-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** ENO_GREENFLOW_HAULING_CAPACITY
CREATE VIEW ENO_GREENFLOW_HAULING_CAPACITY AS
SELECT
  Z.ENO_ID
  ,Z.ENO_RESULTSOURCE
  ,Z.DEPOT_FAC_ID
  ,Z.DISP_FAC_SHORT_NM
  ,Z.LOB
  ,Z.SUBLOB
  ,Z.NBR_OF_TRUCKS
  ,Z.HRS_PER_DAY
  ,Z.TRUCK_CAPACITY_HOURS
  ,Z.TOTAL_COLLECTION_HRS
  ,Z.MIN_HRS
  ,Z.MAX_HRS
  ,Z.SOLUTION_HRS
  ,CASE WHEN (NVL(Z.MAX_HRS,0) - NVL(Z.SOLUTION_HRS,0)) > 0 THEN (NVL(Z.MAX_HRS,0) - NVL(Z.SOLUTION_HRS,0)) ELSE 0 END AS REMAINING_CAPACITY
  ,CASE WHEN (NVL(Z.SOLUTION_HRS,0) - NVL(Z.MAX_HRS,0)) > 0 THEN (NVL(Z.SOLUTION_HRS,0) - NVL(Z.MAX_HRS,0)) ELSE 0 END AS OVER_USE
  ,CASE WHEN (NVL(Z.MIN_HRS,0) - NVL(Z.SOLUTION_HRS,0)) > 0 THEN (NVL(Z.MIN_HRS,0) - NVL(Z.SOLUTION_HRS,0)) ELSE 0 END AS UNDERUSE
FROM
(
  SELECT
  EGS.ENO_ID
  ,EGS.ENO_RESULTSOURCE
  ,EGS.DEPOT_FAC_ID AS DEPOT_FAC_ID
  ,NVL(MF.FAC_SHORT_NM,MF.FAC_NAME) AS DISP_FAC_SHORT_NM
  ,SH.LOB AS LOB
  ,EGS.SUBLOB
  ,HSC.TRUCK_CNT AS NBR_OF_TRUCKS
  ,NVL(HSC.HOURS_PER_TRUCK,10) AS HRS_PER_DAY
  ,MHP.TRUCK_CAPACITY as TRUCK_CAPACITY_HOURS
  ,MHP.TOTAL_COLLECTION_HRS AS TOTAL_COLLECTION_HRS
  ,MHP.MIN_HRS AS MIN_HRS
  ,MHP.MAX_HRS AS MAX_HRS
  ,SUM(TRIP_HRS) AS SOLUTION_HRS
  FROM STG.ENO_GREENFLOW_SOLUTION_RESULTS EGS
  JOIN MART.model_hrs_cap_PERSISTENT MHP
  ON EGS.DEPOT_FAC_ID = MHP.FAC_ID
  AND EGS.SUBLOB = MHP.SUBLOB
  AND EGS.ENO_ID = MHP.ENO_ID
  LEFT JOIN MART.MODEL_FACILITIES_PERSISTENT MF
  ON MHP.FAC_ID = MF.FAC_ID
  AND MHP.ENO_ID = MF.ENO_ID
  LEFT JOIN MART.SUBLOB_HIERARCHY SH
  ON MHP.SUBLOB = SH.SUBLOB
  LEFT JOIN MART.HAULING_SITE_CAPACITY HSC
  ON HSC.FAC_ID = SUBSTR(MHP.FAC_ID,1,6)
  AND HSC.SUBLOB = MHP.SUBLOB
  GROUP BY
   EGS.ENO_ID
  ,EGS.ENO_RESULTSOURCE
  ,EGS.DEPOT_FAC_ID
  ,NVL(MF.FAC_SHORT_NM,MF.FAC_NAME)
  ,SH.LOB
  ,EGS.SUBLOB
  ,HSC.TRUCK_CNT
  ,HSC.HOURS_PER_TRUCK
  ,MHP.TRUCK_CAPACITY
  ,MHP.TOTAL_COLLECTION_HRS
  ,MHP.MIN_HRS
  ,MHP.MAX_HRS
) Z
;
