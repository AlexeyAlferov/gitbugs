-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** MA_ASSIGNMENT
CREATE VIEW MA_ASSIGNMENT as (SELECT 
  "FAC_ID", 
  "FAC_MA_NM", 
  "FAC_MA_IDU" 
FROM (    with TONNAGE_BASED as (
      select * from
          ( select MATCHED_LOCATION_CODE as FAC_ID, FAC_MA_NM, FAC_MA_IDU,
            sum(TONNAGE) as TONNAGE,
            row_number() over (partition by MATCHED_LOCATION_CODE order by SUM(TONNAGE) desc nulls last) as rnk    -- break the tie if facility in multiple MAs
                                                                                                      -- Choose one with highest tonnage
            from DEV_ONEWM.MART.LOCATION_MATCHING_SAS t1,
                DEV_CORPDB.ODS.RDN2_FAC_FULL t2
            where  t1.HAULING_SITE_CD = t2.FAC_IDU  and MATCHED_LOCATION_CODE not like 'S0%'          -- not only S0
                                                    and MATCHED_LOCATION_CODE not like 'S1%'
                                                    and MATCHED_LOCATION_CODE not like 'S5%'
            group by MATCHED_LOCATION_CODE, FAC_MA_NM, FAC_MA_IDU )
      where rnk=1)
    select FAC_ID, FAC_MA_NM, FAC_MA_IDU from TONNAGE_BASED
    union all
    select FAC_ID, FAC_MA_NM, FAC_MA_IDU 
    from DEV_ONEWM.MART.TMS_MARKET_AREAS WHERE NOT EXISTS 
    (select 1 from TONNAGE_BASED where TONNAGE_BASED.FAC_ID = TMS_MARKET_AREAS.FAC_ID)
) AS "v_0000017686_0000143792");
