-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** MODEL_TMS_HISTORY
CREATE VIEW MODEL_TMS_HISTORY AS

SELECT ttwt.lane_origin_fac_Id, ttwt.waste_Type, ttwt.lane_destination_fac_Id, sum(tons) AS tons,

--

-- get this percentage of volume which this lane represents when compared with other

-- lanes with the same waste types from this transfer stations

-- filter against MODEL_COLLECTION_POINTS - so we are only calculating the percentages for available lanes

-- e.g. if we have historical traffic for a given lane but that lane is not active (i.e. not in MODEL_TRANSFER_COSTS

-- then the volume will be distributed across the remaining active lanes

--

	sum(tons) * 100 / sum(sum(tons)) OVER (PARTITION BY ttwt.lane_origin_fac_Id, ttwt.waste_Type) AS PCT

	FROM 	MART.TMS_TONS_WASTE_TYPE TTWT INNER JOIN

			MART.PRE_MODEL_TRANSFER_COSTS MTC

			ON 	mtc.lane_origin_fac_id = ttwt.lane_origin_fac_id

			AND	mtc.waste_type = ttwt.waste_type

			AND mtc.lane_destination_fac_id = ttwt.lane_destination_fac_id

	WHERE transfer_Date BETWEEN current_date-$tms_weeks*7-6 AND current_date-7  -- can take several days for data to arrive

	GROUP BY ttwt.lane_origin_fac_Id, ttwt.waste_Type, ttwt.lane_destination_fac_Id;
