-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** ENO_GREENFLOW_FACILITY_MATERIAL_CAPACITY
CREATE VIEW ENO_GREENFLOW_FACILITY_MATERIAL_CAPACITY AS
SELECT DISTINCT
	EGS.ENO_ID AS ENO_ID
	,EGS.ENO_RESULTSOURCE AS ENO_RESULTSOURCE
	,EGS.DISP_FAC_ID AS DISP_FAC_ID
	,EGS.DISP_FAC_TYPE
	,EGS.DISP_FAC_SHORT_NM
  ,EGS.WASTE_TYPE
	,MAC.VOLUME_CONSTRAINT_TYPE
	,MAC.VOLUME_TIME_UNIT
	,MAC.GOVERNING_MAX_FLAG AS GOVERNING_MAX_IND
	,MAC.GOVERNING_MIN_FLAG AS GOVERNING_MIN_IND
	,NVL(MAC.MIN_TONS_SCALED,0) AS MIN_TONS
	,NVL(MAC.MAX_TONS_SCALED,0) AS MAX_TONS
	,CASE WHEN (NVL(MAC.MIN_TONS_SCALED,0) - NVL(EGS.THREEP_TONS,0)) < 0
				THEN 0
	 			ELSE (NVL(MAC.MIN_TONS_SCALED,0) - NVL(EGS.THREEP_TONS,0))
		END AS MIN_TONS_EXCL_3P
	,CASE WHEN (NVL(MAC.MAX_TONS_SCALED,0) - NVL(EGS.THREEP_TONS,0)) < 0
				THEN 0
	 			ELSE (NVL(MAC.MAX_TONS_SCALED,0) - NVL(EGS.THREEP_TONS,0))
		END AS MAX_TONS_EXCL_3P
	,(NVL(EGS.WM_TONS,0) + NVL(EGS.THREEP_TONS,0)) AS SOLUTION_TOTAL_TONS
	,NVL(EGS.WM_TONS,0) AS SOLUTION_WM_TONS
	,NVL(EGS.THREEP_TONS,0) AS SOLUTION_3P_TONS
	,CASE WHEN (NVL(MAC.MAX_TONS_SCALED,0) - NVL(SOLUTION_TOTAL_TONS,0)) > 0 THEN (NVL(MAC.MAX_TONS_SCALED,0) - NVL(SOLUTION_TOTAL_TONS,0)) ELSE NULL END AS REMAINING_CAPACITY
	,CASE WHEN MAC.MAX_TONS_SCALED IS NULL THEN NULL ELSE (NVL(SOLUTION_TOTAL_TONS,0) - NVL(MAC.MAX_TONS_SCALED,0)) END AS OVER_USE
	--,CASE WHEN (NVL(SOLUTION_TOTAL_TONS,0) - NVL(MAC.MAX_TONS_SCALED,0)) > 0 THEN (NVL(SOLUTION_TOTAL_TONS,0) - NVL(MAC.MAX_TONS_SCALED,0)) ELSE NULL END AS OVER_USE
	,CASE WHEN (NVL(MAC.MIN_TONS_SCALED,0) - NVL(SOLUTION_TOTAL_TONS,0)) > 0 THEN (NVL(MAC.MIN_TONS_SCALED,0) - NVL(SOLUTION_TOTAL_TONS,0)) ELSE NULL END AS UNDERUSE
FROM
(
	SELECT
	EGS.ENO_ID, EGS.DISP_FAC_ID, EGS.ENO_RESULTSOURCE, EGS.WASTE_TYPE,
	MFP.FAC_TYPE AS DISP_FAC_TYPE
	,NVL(MFP.FAC_SHORT_NM, MFP.FAC_NAME) AS DISP_FAC_SHORT_NM
  ,SUM( CASE WHEN EGS.SUBLOB  = '3PLOB' THEN TONS ELSE 0 END) AS THREEP_TONS,
	SUM( CASE WHEN EGS.SUBLOB  = '3PLOB' THEN 0 ELSE TONS END) AS WM_TONS
	FROM STG.ENO_GREENFLOW_SOLUTION_RESULTS EGS
	LEFT JOIN MART.MODEL_FACILITIES_PERSISTENT MFP
		ON MFP.ENO_ID = EGS.ENO_ID
		AND MFP.FAC_ID = EGS.DISP_FAC_ID
	GROUP BY EGS.ENO_ID, EGS.DISP_FAC_ID, EGS.ENO_RESULTSOURCE, EGS.WASTE_TYPE, MFP.FAC_TYPE, NVL(MFP.FAC_SHORT_NM, MFP.FAC_NAME)
) EGS
LEFT JOIN MART.MODEL_ALL_CONSTRAINTS_PERSISTENT MAC
	ON MAC.FAC_ID = EGS.DISP_FAC_ID
	AND MAC.ENO_ID = EGS.ENO_ID
    AND MAC.WASTE_TYPE = EGS.WASTE_TYPE
WHERE MAC.SRC = 'WASTE_TYPE'
;
