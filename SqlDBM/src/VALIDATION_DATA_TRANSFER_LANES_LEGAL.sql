-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** VALIDATION_DATA_TRANSFER_LANES_LEGAL
CREATE VIEW VALIDATION_DATA_TRANSFER_LANES_LEGAL AS
SELECT TC.LANE_ORIGIN_FAC_ID AS TS_FAC_ID, TOTAL_TONS
	   ,'Transfer Lane with origin '||TC.LANE_ORIGIN_FAC_ID||', destination '||TC.LANE_DESTINATION_FAC_ID || ' and waste type '||TC.WASTE_TYPE ||
	    case when DS_ORIGIN.STATUS_IND IS NULL then ' has origin nonexistent in model facilities.' else '' end ||
        case when DS_ORIGIN.STATUS_IND IS NOT NULL and DS_ORIGIN.STATUS_IND != 'A' then ' has inactive origin.'  else '' end ||
        case when DS_DEST.STATUS_IND IS NULL then ' has destination nonexistent in model facilities.' ELSE  '' end ||
        case when DS_DEST.STATUS_IND IS NOT NULL and DS_DEST.STATUS_IND != 'A' then ' has inactive destination.' else '' end ||
	    CASE WHEN TOTAL_RECORDS IS NULL THEN ' Transfer Lane Origin and waste type have no collection points  ' ELSE
        ' Transfer Lane origin and waste type accounts for '||TOTAL_RECORDS ||' Collection Points and '||round(TOTAL_TONS,2)||' Tons' END AS DETAIL
	  ,SUBSTR(TC.LANE_ORIGIN_FAC_ID,1,6) AS LH_PARM_1
	  ,LH_FAC_TYPE(TC.LANE_ORIGIN_FAC_ID)  AS LH_PARM_2
      ,NULL AS LH_PARM_3
	  ,NULL AS LH_PARM_4
	  ,NULL AS LH_PARM_5
FROM MODEL_TRANSFER_COSTS TC
LEFT JOIN MODEL_FACILITIES DS_ORIGIN ON TC.LANE_ORIGIN_FAC_ID=DS_ORIGIN.FAC_ID
LEFT JOIN MODEL_FACILITIES DS_DEST ON TC.LANE_DESTINATION_FAC_ID=DS_DEST.FAC_ID
LEFT JOIN
(
	SELECT DISPFACID, WASTE_TYPE
		  ,COUNT(*) AS TOTAL_RECORDS
		  ,SUM(TONS) AS TOTAL_TONS
	FROM MODEL_COLLECTION_POINTS
	GROUP BY DISPFACID, WASTE_TYPE
)MP ON TC.LANE_ORIGIN_FAC_ID = MP.DISPFACID  AND TC.WASTE_TYPE = MP.WASTE_TYPE
WHERE DS_ORIGIN.FAC_ID IS NULL OR UPPER(DS_ORIGIN.STATUS_IND) != 'A' OR
      DS_DEST.FAC_ID IS NULL OR UPPER(DS_DEST.STATUS_IND) != 'A'
;
