-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** PRE_MODEL_TRANSFER_COSTS
CREATE VIEW PRE_MODEL_TRANSFER_COSTS AS
--
--Average load size of all active transfer lanes with the same destination facility type, waste type, and unit of cost
--
WITH AVERAGE_LOAD_SIZE_TONS_UNIT_PRICE as
(
  SELECT substr(UPPER(LANE_DESTINATION_FAC_ID),8) AS FAC_TYPE,
    WASTE_TYPE,
    CASE WHEN LONG_HAUL_COST_PER_TON IS NOT NULL THEN 'COST PER TON'
          WHEN LONG_HAUL_COST_PER_LOAD IS NOT NULL THEN 'COST PER LOAD'
     END AS UNIT_OF_MEASURE, --UNIT OF COST WHEN LONG_HAUL_COST_PER_TON IS NULL THEN 'COST PER TON' ELSE 'COST PER LOAD'
    AVG(AVERAGE_LOAD_SIZE_TONS)::NUMERIC(10,2) as AVERAGE_LOAD_SIZE_TONS
  FROM TRANSFER_LANE_WASTE_TYPE a
  WHERE STATUS_IND = 'A'
  --and MARKET_AREA_CD = $market_area
  GROUP BY 1,2,3
),
--
--Average load size of all active transfer lanes with the same destination facility type and waste type
--
AVERAGE_LOAD_SIZE_TONS_UNIT_PRICE_WASTE_TYPE as
(
  SELECT substr(UPPER(LANE_DESTINATION_FAC_ID),8) AS FAC_TYPE,
    WASTE_TYPE,
    AVG(AVERAGE_LOAD_SIZE_TONS)::NUMERIC(10,2) as AVERAGE_LOAD_SIZE_TONS
  FROM TRANSFER_LANE_WASTE_TYPE a
  WHERE STATUS_IND = 'A'
  GROUP BY 1,2
)
SELECT TL.LANE_ORIGIN_FAC_ID
	,TL.WASTE_TYPE
	,TL.LANE_DESTINATION_FAC_ID
	,TL.LONG_HAUL_COST_PER_TON
	,TL.LONG_HAUL_COST_PER_LOAD
	,COALESCE(TL.LONG_HAUL_COST_PER_TON, TL.LONG_HAUL_COST_PER_LOAD) AS LONG_HAUL_COST
	,CASE WHEN TL.LONG_HAUL_COST_PER_TON is NOT NULL then 1
				WHEN TL.LONG_HAUL_COST_PER_LOAD is NOT NULL
               THEN coalesce(TL.AVERAGE_LOAD_SIZE_TONS,A1.AVERAGE_LOAD_SIZE_TONS,A2.AVERAGE_LOAD_SIZE_TONS,25)
	 END AS LOAD_SIZE
	,TL.UNIT_OF_MEASURE
	,MIN_TONS * (
		 CASE
		    --NB: Transfer lanes do not have min/max specified hourly
            WHEN UPPER(VOLUME_TIME_UNIT)='DAILY' THEN sc.DAILY_FACTOR
            WHEN UPPER(VOLUME_TIME_UNIT)='MONTHLY' THEN sc.MONTHLY_FACTOR
            WHEN UPPER(VOLUME_TIME_UNIT)='QUARTERLY' THEN sc.QTR_FACTOR
            WHEN UPPER(VOLUME_TIME_UNIT)='YEARLY' THEN sc.YEARLY_FACTOR
        ELSE 1 END
		) AS MIN_TONS
	,MAX_TONS * (
		 CASE
		    --NB: Transfer lanes do not have min/max specified hourly
            WHEN UPPER(VOLUME_TIME_UNIT)='DAILY' THEN sc.DAILY_FACTOR
            WHEN UPPER(VOLUME_TIME_UNIT)='MONTHLY' THEN sc.MONTHLY_FACTOR
            WHEN UPPER(VOLUME_TIME_UNIT)='QUARTERLY' THEN sc.QTR_FACTOR
            WHEN UPPER(VOLUME_TIME_UNIT)='YEARLY' THEN sc.YEARLY_FACTOR
        ELSE 1 END
		) AS MAX_TONS
	,'WM' AS source
	,0 AS ADDL_UNIT_COST
	,STATUS_IND
FROM
(
  SELECT *
    ,substr(UPPER(LANE_DESTINATION_FAC_ID),8) AS FAC_TYPE
    ,CASE WHEN A.LONG_HAUL_COST_PER_TON IS NOT NULL THEN 'COST PER TON'
          WHEN A.LONG_HAUL_COST_PER_LOAD IS NOT NULL THEN 'COST PER LOAD'
    END AS UNIT_OF_MEASURE
  FROM TRANSFER_LANE_WASTE_TYPE A
)TL
LEFT JOIN AVERAGE_LOAD_SIZE_TONS_UNIT_PRICE A1
  ON TL.FAC_TYPE = A1.FAC_TYPE
  AND TL.WASTE_TYPE = A1.WASTE_TYPE
  AND TL.UNIT_OF_MEASURE = A1.UNIT_OF_MEASURE
LEFT JOIN AVERAGE_LOAD_SIZE_TONS_UNIT_PRICE_WASTE_TYPE A2
  ON TL.FAC_TYPE = A2.FAC_TYPE
  AND TL.WASTE_TYPE = A2.WASTE_TYPE
LEFT JOIN SCALE_CONSTRAINTS sc
WHERE STATUS_IND = 'A'
	AND LANE_ORIGIN_FAC_ID IN (
		SELECT FAC_ID
		FROM MODEL_FACILITY_LIST
		)
;
