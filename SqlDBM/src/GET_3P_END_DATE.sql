-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** GET_3P_END_DATE
CREATE FUNCTION GET_3P_END_DATE(NUM_WEEKS_3P FLOAT, START_DATE DATE, END_DATE DATE, MAX_END_DATE DATE)
RETURNS DATE
LANGUAGE JAVASCRIPT
IMMUTABLE
COMMENT='Get max dates for calculating 3P averages for PMT_LANDFILLS and PMT_TRANSFERS'
AS '
    // Get num weeks in end_date - start_date
    var extant_weeks = Math.round((END_DATE - START_DATE) / 1000 / 60 / 60 / 24 / 7);
    // forward padding should be the greater of integer division of half the difference between extant
    // weeks and num_weeks_3p
    var week_diff = (NUM_WEEKS_3P - extant_weeks) / 2;

    var end_3p = END_DATE; // we are right-aligning if num_weeks_3p < extant_weeks
    if(extant_weeks < NUM_WEEKS_3P){
        end_3p.setDate(end_3p.getDate() + Math.ceil(week_diff)*7);
    }

    // cap end_3p at first week beginning before maximum end date
    if(end_3p > MAX_END_DATE){
        // we have a sunday beginning of week here
        end_3p.setDate(MAX_END_DATE.getDate() - MAX_END_DATE.getDay());
    }
    return end_3p;
';
