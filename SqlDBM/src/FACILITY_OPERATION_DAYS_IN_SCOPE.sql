-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** FACILITY_OPERATION_DAYS_IN_SCOPE
CREATE VIEW FACILITY_OPERATION_DAYS_IN_SCOPE AS 
select ttl_days.FAC_ID, ttl_days.FAC_TYPE, DAYS_IN_SCOPE - nvl(FACILITY_CLOSED_DAYS_IN_SCOPE,0) FACILITY_OPERATIONAL_DAYS_IN_SCOPE
from
(select FAC_ID, FAC_TYPE, COUNT(CALNDR_DT) DAYS_IN_SCOPE
from "STG"."DIM_DT_CALNDR_DAY" DT_DIM
join mart.LH_SITE s 
on CALNDR_DT  between '2020-01-01' and '2020-03-05'
GROUP BY 1,2) ttl_days
left join 
(select FAC_ID, FAC_TYPE, COUNT(CALNDR_DT) FACILITY_CLOSED_DAYS_IN_SCOPE
from "STG"."DIM_DT_CALNDR_DAY" DT_DIM
join mart.BMT_FACILITY_CLOSED_DAYS_VW cls
on DT_DIM.DAY_WEEK_NM  = cls.Closed_day
and CALNDR_DT  between '2020-01-01' and '2020-03-05'
GROUP BY 1,2) clsd
on ttl_days.FAC_ID=clsd.FAC_ID
and ttl_days.FAC_TYPE = clsd.FAC_TYPE;
