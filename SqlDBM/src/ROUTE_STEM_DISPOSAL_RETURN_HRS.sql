-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** ROUTE_STEM_DISPOSAL_RETURN_HRS
CREATE VIEW ROUTE_STEM_DISPOSAL_RETURN_HRS AS

SELECT

    HAULING_SITE

    ,RO_KEY

    ,SUBLOB

    ,EVENT_TYPE

    ,EVENT_START

    ,EVENT_END

    ,COALESCE(TRAVEL_TIME_TO_HRS,0) TRAVEL_TIME_TO_HRS_CLEAN

    ,COALESCE(TRAVEL_TIME_FROM_HRS,0) AS TRAVEL_TIME_FROM_HRS_CLEAN

    ,COALESCE(EVENT_HRS,0) AS TRAVEL_TIME_EVENT_CLEAN

    ,CASE  -- a lot of routes are missing customer events. Without special handling, this causes

    -- double counting of travel time. Note that a lot of these cases have been superceded by

    -- collection time imputation in SUBLOB_STEM_DISPOSAL_RETURN_HRS

      WHEN PREVIOUS_EVENT_TYPE = 'CUSTOMER'

        THEN TRAVEL_TIME_TO_HRS_CLEAN + TRAVEL_TIME_EVENT_CLEAN + TRAVEL_TIME_FROM_HRS_CLEAN

      WHEN EVENT_TYPE IN ('Arrive Yard', 'landfill') AND PREVIOUS_EVENT_TYPE = 'Leave Yard'

        THEN TRAVEL_TIME_TO_HRS_CLEAN * 0.3 + TRAVEL_TIME_EVENT_CLEAN

      ELSE TRAVEL_TIME_EVENT_CLEAN + TRAVEL_TIME_FROM_HRS_CLEAN

    END AS TOTAL_HRS -- Avoid double-counting travel-time when no customers registered

    ,SERVICE_DT

FROM CO_EVENT_TIME_INCREMENT

WHERE UPPER(EVENT_TYPE) IN ('LEAVE YARD','LANDFILL','ARRIVE YARD') AND SUBLOB IS NOT NULL

AND HAULING_SITE IN (SELECT DISTINCT REPLACE(FAC_ID,'_Depot') FROM MODEL_DEPOT_LOB);
