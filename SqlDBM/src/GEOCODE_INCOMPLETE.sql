-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** GEOCODE_INCOMPLETE
CREATE VIEW GEOCODE_INCOMPLETE as
WITH ALL_LAT_LONG AS
(SELECT
    RFACT.LATITUDE,
    RFACT.LONGITUDE,
	HS.MARKET_AREA_CD
FROM MART.CORP_COMRES_FACT RFACT
JOIN MART.HAULING_SITE HS
ON HS.FAC_ID =RFACT.DEPOTFACID

UNION

SELECT
    
    RFACT.LATITUDE,
    RFACT.LONGITUDE,
	HS.MARKET_AREA_CD
FROM MART.CORP_ROLLOFF_FACT RFACT
JOIN MART.HAULING_SITE HS
ON HS.FAC_ID =RFACT.DEPOTFACID
)
SELECT DISTINCT
    truncate(corp.LATITUDE,6) as LATITUDE,                          truncate(corp.LONGITUDE,6) as LONGITUDE , MARKET_AREA_CD
FROM ALL_LAT_LONG corp
LEFT JOIN GEOCODE_RESULTS geo
    ON
        TRUNCATE(corp.LATITUDE,6)=TRUNCATE(geo.LATITUDE,6) AND            TRUNCATE(corp.LONGITUDE,6)=TRUNCATE(geo.LONGITUDE,6)
WHERE geo.LONGITUDE IS NULL OR geo.LATITUDE IS NULL;
