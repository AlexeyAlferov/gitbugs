-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** COMM_POSSIBLE_ROUTE_EVENTS_BEFORE_LANDFILL
CREATE VIEW COMM_POSSIBLE_ROUTE_EVENTS_BEFORE_LANDFILL as

select FROMYARD EVENT_BEFORE_LANDFILL, fk_routeorder 

from STG.tp_ro_result ros

join STG.tp_routeorder ro

on ro.pkey = ros.fk_routeorder 

AND ROS.FK_VEHICLE IS NULL 

AND ROS.FROMYARD IS NOT NULL

AND RO.ORDERDATE >='2019-01-01'

AND RO.STATUSCODE='CONFIRMED'

join STG.tp_rouTe r 

on r.pkey = ro.fk_route

join STG.tp_lob lob

on lob.pkey = r.fk_lob 

and lob."NAME" ='COMMERCIAL'



UNION  ALL 



SELECT COR.DEPARTCUSTOMER , CO.FK_ROUTEORDER 

FROM STG.TP_CUSTOMERORDER CO

JOIN STG.TP_ROUTEORDER RO

ON RO.PKEY = CO.FK_ROUTEORDER 

AND RO.ORDERDATE >='2019-01-01'

AND RO.STATUSCODE='CONFIRMED'

JOIN STG.TP_CO_RESULT  COR 

ON COR.FK_VEHICLE IS NULL 

AND COR.FK_CUSTOMERORDER = CO.PKEY 

JOIN STG.TP_ROUTE R 

ON R.PKEY = RO.FK_ROUTE 

JOIN STG.TP_LOB L 

ON L.PKEY =R.FK_LOB

AND L."NAME" ='COMMERCIAL'



UNION ALL 



SELECT COR.STOPTICKET , CO.FK_ROUTEORDER 

FROM 

STG.TP_CUSTOMERORDER CO

JOIN STG.TP_ROUTEORDER RO

ON RO.PKEY = CO.FK_ROUTEORDER 

AND RO.ORDERDATE >='2019-01-01'

AND RO.STATUSCODE='CONFIRMED'

JOIN STG.TP_CO_RESULT  COR 

ON COR.FK_VEHICLE IS NULL 

AND COR.STOPTICKET IS NOT NULL

AND COR.FK_CUSTOMERORDER = CO.PKEY 

JOIN STG.TP_ROUTE R 

ON R.PKEY = RO.FK_ROUTE 

JOIN STG.TP_LOB L 

ON L.PKEY =R.FK_LOB

AND L."NAME" ='COMMERCIAL'

;
