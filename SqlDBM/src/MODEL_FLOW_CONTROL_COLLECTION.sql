-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** MODEL_FLOW_CONTROL_COLLECTION
CREATE VIEW MODEL_FLOW_CONTROL_COLLECTION AS

--Get all non-special rate rules
WITH NON_SPECIAL_RATE_RULES AS
(SELECT * FROM MODEL_FLOW_CONTROL_RULES
WHERE METHOD_TYPE != 5),

-- GET all state-level rules (excluding special rate)
STATE_FLOW_CONTROL AS
(SELECT
    FC_RULE_NUMBER
    ,RULE_SOURCE
    ,METHOD_TYPE
    ,LOB
    ,WASTE_TYPE
    ,COLLECTION_ENTITY
    ,MIN_TONS
    ,MAX_TONS
FROM NON_SPECIAL_RATE_RULES where RULE_SOURCE='State'),

-- GET all county-level rules (excluding special rate)
COUNTY_FLOW_CONTROL AS
(SELECT
    FC_RULE_NUMBER
    ,RULE_SOURCE
    ,METHOD_TYPE
    ,LOB
    ,WASTE_TYPE
    ,COLLECTION_ENTITY
    ,MIN_TONS
    ,MAX_TONS
FROM NON_SPECIAL_RATE_RULES where RULE_SOURCE='County'),

-- GET all city-level rules (excluding special rate)
CITY_FLOW_CONTROL AS
(SELECT
    FC_RULE_NUMBER
    ,RULE_SOURCE
    ,METHOD_TYPE
    ,LOB
    ,WASTE_TYPE
    ,COLLECTION_ENTITY
    ,MIN_TONS
    ,MAX_TONS
FROM NON_SPECIAL_RATE_RULES where RULE_SOURCE='City'),

-- GET all site-level rules (excluding special rate)
HAULING_SITE_FLOW_CONTROL AS
(SELECT
    FC_RULE_NUMBER
    ,RULE_SOURCE
    ,METHOD_TYPE
    ,LOB
    ,WASTE_TYPE
    ,COLLECTION_ENTITY
    ,MIN_TONS
    ,MAX_TONS
FROM NON_SPECIAL_RATE_RULES where RULE_SOURCE='Hauling Site'),

-- GET all Hauling Site - OCS Rules rules (excluding special rate)
OCS_FLOW_CONTROL AS
(SELECT
    FC_RULE_NUMBER
    ,RULE_SOURCE
    ,METHOD_TYPE
    ,LOB
    ,WASTE_TYPE
    ,COLLECTION_ENTITY
    ,MIN_TONS
    ,MAX_TONS
FROM NON_SPECIAL_RATE_RULES where RULE_SOURCE='OCS Code'),

--Create the table for all state-sourced flow controls and associated collection points
FLOW_CONTROL_STATE_COLLECTION AS
(SELECT
    fc.FC_RULE_NUMBER
    ,fc.LOB AS FC_LOB
    ,fc.WASTE_TYPE AS FC_WASTE_TYPE
    ,cp.ROWNUMBER
    ,cp.LOB
    ,cp.WASTE_TYPE
FROM STATE_FLOW_CONTROL fc
INNER JOIN MODEL_COLLECTION_POINTS cp ON UPPER(cp.GEO_STATE_CD)=UPPER(fc.COLLECTION_ENTITY)
WHERE ((fc.LOB=cp.LOB and fc.WASTE_TYPE=cp.WASTE_TYPE) or
      (UPPER(fc.LOB)='ALL LOBS' AND fc.WASTE_TYPE=cp.WASTE_TYPE) OR
      (fc.LOB=cp.LOB and UPPER(fc.WASTE_TYPE)='ALL') OR
      (UPPER(fc.LOB)='ALL LOBS' AND UPPER(fc.WASTE_TYPE)='ALL'))),

--Create the table for all county-souced flow controls and associated collection points
FLOW_CONTROL_COUNTY_COLLECTION AS
(SELECT
    fc.FC_RULE_NUMBER
    ,fc.LOB AS FC_LOB
    ,fc.WASTE_TYPE AS FC_WASTE_TYPE
    ,cp.ROWNUMBER
    ,cp.LOB
    ,cp.WASTE_TYPE
FROM COUNTY_FLOW_CONTROL fc
INNER JOIN MODEL_COLLECTION_POINTS cp ON UPPER(cp.GEO_STATE_CD||'-'||cp.GEO_COUNTY_NM) = UPPER(fc.COLLECTION_ENTITY)
WHERE ((fc.LOB=cp.LOB and fc.WASTE_TYPE=cp.WASTE_TYPE) or
      (UPPER(fc.LOB)='ALL LOBS' AND fc.WASTE_TYPE=cp.WASTE_TYPE) OR
      (fc.LOB=cp.LOB and UPPER(fc.WASTE_TYPE)='ALL') OR
      (UPPER(fc.LOB)='ALL LOBS' AND UPPER(fc.WASTE_TYPE)='ALL'))),

--Create the table for all city-souced flow controls and associated collection points
FLOW_CONTROL_CITY_COLLECTION AS
(SELECT
    fc.FC_RULE_NUMBER
    ,fc.LOB AS FC_LOB
    ,fc.WASTE_TYPE AS FC_WASTE_TYPE
    ,cp.ROWNUMBER
    ,cp.LOB
    ,cp.WASTE_TYPE
FROM CITY_FLOW_CONTROL fc
INNER JOIN MODEL_COLLECTION_POINTS cp ON UPPER(cp.GEO_STATE_CD||'-'||cp.GEO_CITY_NM)=UPPER(fc.COLLECTION_ENTITY)
WHERE ((fc.LOB=cp.LOB and fc.WASTE_TYPE=cp.WASTE_TYPE) or
      (UPPER(fc.LOB)='ALL LOBS' AND fc.WASTE_TYPE=cp.WASTE_TYPE) OR
      (fc.LOB=cp.LOB and UPPER(fc.WASTE_TYPE)='ALL') OR
      (UPPER(fc.LOB)='ALL LOBS' AND UPPER(fc.WASTE_TYPE)='ALL'))),

--Create the table for all site-souced flow controls and associated collection points
FLOW_CONTROL_SITE_COLLECTION AS
(SELECT
    fc.FC_RULE_NUMBER
    ,fc.LOB AS FC_LOB
    ,fc.WASTE_TYPE AS FC_WASTE_TYPE
    ,cp.ROWNUMBER
    ,cp.LOB
    ,cp.WASTE_TYPE
FROM HAULING_SITE_FLOW_CONTROL fc
INNER JOIN MODEL_COLLECTION_POINTS cp ON UPPER(cp.DEPOTFACID)=UPPER(fc.COLLECTION_ENTITY||'_DEPOT')
WHERE ((fc.LOB=cp.LOB and fc.WASTE_TYPE=cp.WASTE_TYPE) or
      (UPPER(fc.LOB)='ALL LOBS' AND fc.WASTE_TYPE=cp.WASTE_TYPE) OR
      (fc.LOB=cp.LOB and UPPER(fc.WASTE_TYPE)='ALL') OR
      (UPPER(fc.LOB)='ALL LOBS' AND UPPER(fc.WASTE_TYPE)='ALL'))),

 -- Create the table for all Hauling Site OCS flow controls and associated collection points
 -- We are looking for a match on both the Depot and also checking to see if the OCS disposal code contains the OCS disposal code list in the flow control
 -- Some OCS Disposal codes have multiple - e.g ABC, DEF - the CONTAINS handles this scenario
 FLOW_CONTROL_OCS_COLLECTION AS
(SELECT
    fc.FC_RULE_NUMBER
    ,fc.LOB AS FC_LOB
    ,fc.WASTE_TYPE AS FC_WASTE_TYPE
    ,cp.ROWNUMBER
    ,cp.LOB
    ,cp.WASTE_TYPE
FROM OCS_FLOW_CONTROL fc
 INNER JOIN MODEL_COLLECTION_POINTS cp ON UPPER(cp.DEPOTFACID)=UPPER(GET(SPLIT(fc.COLLECTION_ENTITY,'-'),0)||'_DEPOT') AND
 										  CONTAINS( UPPER(CP.OCS_DISPOSAL_CD) , UPPER(GET(SPLIT(fc.COLLECTION_ENTITY,'-'),1) )) AND CP.OCS_DISPOSAL_CD IS NOT NULL
WHERE ((fc.LOB=cp.LOB and fc.WASTE_TYPE=cp.WASTE_TYPE) or
      (UPPER(fc.LOB)='ALL LOBS' AND fc.WASTE_TYPE=cp.WASTE_TYPE) OR
      (fc.LOB=cp.LOB and UPPER(fc.WASTE_TYPE)='ALL') OR
      (UPPER(fc.LOB)='ALL LOBS' AND UPPER(fc.WASTE_TYPE)='ALL')))



--Create table
SELECT
    FC_RULE_NUMBER
    ,ROWNUMBER
FROM FLOW_CONTROL_STATE_COLLECTION
UNION
SELECT
    FC_RULE_NUMBER
    ,ROWNUMBER
FROM FLOW_CONTROL_COUNTY_COLLECTION
UNION
SELECT
    FC_RULE_NUMBER
    ,ROWNUMBER
FROM FLOW_CONTROL_CITY_COLLECTION
UNION
SELECT
    FC_RULE_NUMBER
    ,ROWNUMBER
FROM FLOW_CONTROL_SITE_COLLECTION
UNION
SELECT
    FC_RULE_NUMBER
    ,ROWNUMBER
FROM FLOW_CONTROL_OCS_COLLECTION
;
