-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** VALIDATION_DATA_NON_MATCHED_OCS
CREATE VIEW VALIDATION_DATA_NON_MATCHED_OCS AS

select

  LOB,

  WASTE_TYPE,

  DEPOTFACID,

  OCS_DISPOSAL_CD,

  OCS_DISPOSAL_NM,

  sum(TONS) AS TOTAL_TONS,

  'MODEL_COLLECTION_POINTS have records with OCS: ' || OCS_DISPOSAL_CD || ' (' || NVL(OCS_DISPOSAL_NM,'<no ocs name>') || ')' || ' that are not matched to any facilities.  Hauling site: ' || DEPOTFACID ||

    ', and total_tons: ' || CAST(CAST(TOTAL_TONS as decimal(15,1)) as string)

   as DETAIL

from

(select

  C.LOB,

  C.WASTE_TYPE,

  C.DEPOTFACID,

  C.OCS_DISPOSAL_CD,

  C.OCS_DISPOSAL_NM,

  C.TONS

from COMRES_FACT C

left join LOCATION_MATCHING LM on LM.HAULING_SITE_ID = C.DEPOTFACID and LM.OCS_DISPOSAL_CD = C.OCS_DISPOSAL_CD

WHERE

  LM.MATCHED_LOCATIONID_TYPE is null and

  (C.SERVICE_DT BETWEEN $start_date AND $end_date) and

  C.DEPOTFACID IN (SELECT FAC_ID FROM HAULING_SITE WHERE MARKET_AREA_CD=$market_area)

union all

select

  R.LOB,

  R.WASTE_TYPE,

  R.DEPOTFACID,

  R.OCS_DISPOSAL_CD,

  R.OCS_DISPOSAL_NM,

  R.TONS

from ROLLOFF_FACT R

left join LOCATION_MATCHING LM on LM.HAULING_SITE_ID = R.DEPOTFACID and LM.OCS_DISPOSAL_CD = R.OCS_DISPOSAL_CD

WHERE

  LM.MATCHED_LOCATIONID_TYPE is null and

  (R.SERVICE_DT BETWEEN $start_date AND $end_date) and

  R.DEPOTFACID IN (SELECT FAC_ID FROM HAULING_SITE WHERE MARKET_AREA_CD=$market_area)

)

group by

  LOB,

  WASTE_TYPE,

  DEPOTFACID,

  OCS_DISPOSAL_CD,

  OCS_DISPOSAL_NM

order by TOTAL_TONS DESC

;
