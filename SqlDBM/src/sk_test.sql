-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** sk_test
CREATE VIEW sk_test AS 

select

 MART.FAC_ID

,MART.FAC_NAME

,'HS' FAC_TYPE

,MART.ACTIVE_FLAG

,MART.MARKET_AREA_NM

,MART.MARKET_AREA_CD

,MART.ADDRESS_1

,MART.ADDRESS_2

,MART.CITY_NM

,MART.STATE_CD

,MART.ZIP_CD

,MART.LATITUDE

,MART.LONGITUDE

,0 TURN_TIME

,0 MIN_VOLUME

,0 MAX_VOLUME

,0 FIXED_COST

,MART.WM_OWNED_FLAG

,null LAST_UPDATED_DTM

,'CORPDB' DATA_SOURCE

from DEV_ONEWM.MART.corp_HAULING_SITE mart 

left join DEV_ONEWM.STG.facility_location_data_bmt_data_collctn bmt_data_clctn

on mart.FAC_ID = bmt_data_clctn.FAC_ID

where bmt_data_clctn.FAC_ID is null



union all 



select

 MART.FAC_ID

,MART.FAC_NAME

,MART.FAC_TYPE

,MART.ACTIVE_FLAG

,MART.MARKET_AREA_NM

,MART.MARKET_AREA_CD

,MART.ADDRESS_1

,MART.ADDRESS_2

,MART.CITY_NM

,MART.STATE_CD

,MART.ZIP_CD

,MART.LATITUDE

,MART.LONGITUDE

,MART.CYCLE_MINUTE_CNT TURN_TIME

,MART.MIN_VOLUME

,MART.MAX_VOLUME

,MART.FIXED_COST

,MART.WM_OWNED_FLAG

,null LAST_UPDATED_DTM

,mart.source DATA_SOURCE

from DEV_ONEWM.MART.CORP_DISPOSAL_SITE mart

left join DEV_ONEWM.STG.facility_location_data_bmt_data_collctn bmt_data_clctn

on mart.FAC_ID = bmt_data_clctn.FAC_ID

where bmt_data_clctn.FAC_ID is null



union all 





select 

 FAC_ID

,FAC_NAME

,FAC_TYPE

,ACTIVE_FLAG

,MARKET_AREA_NM

,MARKET_AREA_CD

,ADDRESS_1

,ADDRESS_2

,CITY_NM

,STATE_CD

,ZIP_CD

,LATITUDE

,LONGITUDE

,TURN_TIME

,MIN_VOLUME

,MAX_VOLUME

,FIXED_COST

,WM_OWNED_FLAG

,LAST_UPDATED_DTM

,'BMT' DATA_SOURCE

from 

(select

 FAC_ID

,FAC_NAME

,FAC_TYPE

,ACTIVE_FLAG

,MARKET_AREA_NM

,MARKET_AREA_CD

,ADDRESS_1

,ADDRESS_2

,CITY_NM

,STATE_CD

,ZIP_CD

,LATITUDE

,LONGITUDE

,CYCLE_MINUTE_CNT TURN_TIME

,MIN_VOLUME

,MAX_VOLUME

,FIXED_COST

,WM_OWNED_FLAG

,LAST_UPDATED_DTM

,row_number() over (partition by FAC_ID, FAC_TYPE order by LAST_UPDATED_DTM DESC) rn 

from DEV_ONEWM.STG.facility_location_data_bmt_data_collctn

where DATA_COLLCTION_ADD_DELETE_UPDATE in ('A', 'E','U')) A

where a.rn=1;
