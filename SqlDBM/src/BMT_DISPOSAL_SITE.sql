-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** BMT_DISPOSAL_SITE
CREATE VIEW BMT_DISPOSAL_SITE as
select * from
(select
FAC_ID ||'_' ||case when FAC_TYPE = 'Transfer Station' then 'TS'
                when FAC_TYPE = 'MRF Recycling' then 'MRF'
                else FAC_TYPE end as FAC_ID,
               case when FAC_TYPE = 'Transfer Station' then 'TS'
                when FAC_TYPE = 'MRF Recycling' then 'MRF'
                else FAC_TYPE end as FAC_TYPE,
WM_OWNED_FLAG,
FAC_NAME,
FAC_SHORT_NM,
ACTIVE_FLAG,
case when MARKET_AREA_NM = ' ' then null else MARKET_AREA_NM end as MARKET_AREA_NM,
case when MARKET_AREA_CD = ' ' then null else MARKET_AREA_CD end as MARKET_AREA_CD,
LATITUDE,
LONGITUDE,
ADDRESS_1,
ADDRESS_2,
CITY_NM,
STATE_CD,
ZIP_CD,
COUNTRY,
COUNTY_NM,
FIXED_COST,
UNIT_COST,
LAST_UPDATED_DTM,
LAST_UPDATED_USER,
DATA_COLLCTION_ADD_DELETE_UPDATE,
row_number() over (partition by fac_id, fac_type order by last_updated_dtm desc nulls last) as rnk,
GEO_CITY_NM,
GEO_COUNTY_NM,
GEO_STATE_CD,
GEO_ZIP_CD
 from stg.FACILITY_LOCATION_DATA_BMT_DATA_COLLCTN
 where fac_type != 'Collection')  where rnk=1;
