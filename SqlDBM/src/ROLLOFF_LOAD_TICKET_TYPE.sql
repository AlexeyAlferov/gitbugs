-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** ROLLOFF_LOAD_TICKET_TYPE
CREATE VIEW ROLLOFF_LOAD_TICKET_TYPE AS

--

-- Ticket Type data available from OPUS table .  From there we navigate to TP_ROUTEORDER (thanks Ganga)

-- Max eliminates the few duplicate records - duplicate landfill keys always have the same load type

--

SELECT rol.pkey AS landfill_pkey, max(tickt_loadtype_cd) as service_type_cd

FROM DEV_ONEWM.STG.PVW_FCT_RTE_EXECUTION_STOP_RO_FLASH_SUMMRY rolloff 

	JOIN DEV_OCS.ODS.TP_CUSTOMER c 

ON rolloff.src_cust_key_id =c.uniqueid

JOIN DEV_OCS.ODS.TP_CUSTOMERORDER co 	ON co.fk_customer = c.pkey  	AND co.ticketnumber = rolloff.mas_ticket_number 

JOIN DEV_OCS.ODS.TP_ROUTEORDER ro 		ON ro.pkey = co.fk_routeorder 	AND ro.orderdate = rolloff.rte_exec_date 

JOIN DEV_OCS.ODS.TP_RO_LANDFILL rol 	ON ro.pkey =rol.fk_routeorder 	AND rol.fk_vehicle is NULL	AND rol.fk_customerorder = co.pkey  

WHERE rte_exec_date > '2018-12-31'

group by rol.pkey

;
