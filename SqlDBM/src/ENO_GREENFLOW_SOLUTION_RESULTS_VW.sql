-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** ENO_GREENFLOW_SOLUTION_RESULTS_VW
CREATE VIEW ENO_GREENFLOW_SOLUTION_RESULTS_VW AS
SELECT
     BASE.ENO_ID
    ,CAST(BASE.COLLECTION_POINT_ID AS BIGINT) AS COLLECTION_POINT_ID
    ,CASE WHEN BASE.SUBLOB = '3PLOB' THEN '3PLOB' ELSE BASE.LOB END AS LOB
    ,BASE.SUBLOB
  	,BASE.WASTE_TYPE
--B_DEPOT
    ,BASE.DEPOT_FAC_ID B_DEPOT_FAC_ID
    ,MFP.FAC_TYPE AS B_DEPOT_FAC_TYPE
    ,MFP.FAC_NAME AS B_DEPOT_FAC_NAME
    ,NVL(MFP.FAC_SHORT_NM, MFP.FAC_NAME) AS B_DEPOT_FAC_SHORT_NM
    ,MFP.WM_OWNED_FLAG AS B_DEPOT_WM_OWNED_FLAG
    ,MFP.LATITUDE AS B_DEPOT_LATITUDE
    ,MFP.LONGITUDE AS B_DEPOT_LONGITUDE
    ,MFP.GEO_CITY_NM AS B_DEPOT_GEO_CITY_NM
    ,MFP.GEO_COUNTY_NM AS B_DEPOT_GEO_COUNTY_NM
    ,MFP.GEO_STATE_CD AS B_DEPOT_GEO_STATE_CD
    ,MFP.GEO_ZIP_CD AS B_DEPOT_GEO_ZIP_CD
--B_DISP
    ,BASE.DISP_FAC_ID B_DISP_FAC_ID
    ,MFP2.FAC_TYPE AS B_DISP_FAC_TYPE
    ,MFP2.FAC_NAME AS B_DISP_FAC_NAME
    ,NVL(MFP2.FAC_SHORT_NM, MFP2.FAC_NAME) AS B_DISP_FAC_SHORT_NM
    ,MFP2.WM_OWNED_FLAG AS B_DISP_WM_OWNED_FLAG
    ,MFP2.LATITUDE AS B_DISP_LATITUDE
    ,MFP2.LONGITUDE AS B_DISP_LONGITUDE
    ,MFP2.GEO_CITY_NM AS B_DISP_GEO_CITY_NM
    ,MFP2.GEO_COUNTY_NM AS B_DISP_GEO_COUNTY_NM
    ,MFP2.GEO_STATE_CD AS B_DISP_GEO_STATE_CD
    ,MFP2.GEO_ZIP_CD AS B_DISP_GEO_ZIP_CD
--S_DEPOT
    ,DCO.DEPOT_FAC_ID S_DEPOT_FAC_ID
    ,MFP3.FAC_TYPE AS S_DEPOT_FAC_TYPE
    ,MFP3.FAC_NAME AS S_DEPOT_FAC_NAME
    ,NVL(MFP3.FAC_SHORT_NM, MFP3.FAC_NAME)  AS S_DEPOT_FAC_SHORT_NM
    ,MFP3.WM_OWNED_FLAG AS S_DEPOT_WM_OWNED_FLAG
    ,MFP3.LATITUDE AS S_DEPOT_LATITUDE
    ,MFP3.LONGITUDE AS S_DEPOT_LONGITUDE
    ,MFP3.GEO_CITY_NM AS S_DEPOT_GEO_CITY_NM
    ,MFP3.GEO_COUNTY_NM AS S_DEPOT_GEO_COUNTY_NM
    ,MFP3.GEO_STATE_CD AS S_DEPOT_GEO_STATE_CD
    ,MFP3.GEO_ZIP_CD AS S_DEPOT_GEO_ZIP_CD
--S_DISP
    ,DCO.DISP_FAC_ID S_DISP_FAC_ID
    ,MFP4.FAC_TYPE AS S_DISP_FAC_TYPE
    ,MFP4.FAC_NAME AS S_DISP_FAC_NAME
    ,NVL(MFP4.FAC_SHORT_NM, MFP4.FAC_NAME)  AS S_DISP_FAC_SHORT_NM
    ,MFP4.WM_OWNED_FLAG AS S_DISP_WM_OWNED_FLAG
    ,MFP4.LATITUDE AS S_DISP_LATITUDE
    ,MFP4.LONGITUDE AS S_DISP_LONGITUDE
    ,MFP4.GEO_CITY_NM AS S_DISP_GEO_CITY_NM
    ,MFP4.GEO_COUNTY_NM AS S_DISP_GEO_COUNTY_NM
    ,MFP4.GEO_STATE_CD AS S_DISP_GEO_STATE_CD
    ,MFP4.GEO_ZIP_CD AS S_DISP_GEO_ZIP_CD
  	,BASE.TONS
  	,BASE.LOADS
    ,BASE.ROUTE_ID
    ,BASE.LOAD_SEQ
  	,BASE.LOAD_TYPE
  	,BASE.ACCOUNT_NBR
  	,BASE.CUSTOMER_NAME
--CP
    ,MCP.LATITUDE AS CP_LATITUDE
    ,MCP.LONGITUDE AS CP_LONGITUDE
    ,MCP.GEO_CITY_NM AS CP_GEO_CITY_NM
    ,MCP.GEO_COUNTY_NM AS CP_GEO_COUNTY_NM
    ,MCP.GEO_STATE_CD AS CP_GEO_STATE_CD
    ,MCP.GEO_ZIP_CD AS CP_GEO_ZIP_CD
--LEGS
    ,MCP.STEMLEGS AS STEM_LEGS
    ,MCP.RETURN_LEGS AS RETURN_LEGS
    ,MCP.DISPOSALLEGS AS DISPOSAL_LEGS
--BASE/DCO
  	,BASE.ADDRESS
  	,BASE.TRIP_HRS B_TRIP_HRS
  	,DCO.TRIP_HRS S_TRIP_HRS
  	,BASE.TRIP_RATE B_TRIP_RATE
  	,DCO.TRIP_RATE S_TRIP_RATE
  	,BASE.TRIP_COST B_TRIP_COST
  	,DCO.TRIP_COST S_TRIP_COST
  	,BASE.DISP_RATE B_DISP_RATE
  	,DCO.DISP_RATE S_DISP_RATE
  	,BASE.DISP_COST B_DISP_COST
  	,DCO.DISP_COST S_DISP_COST
  	,BASE.TRATE B_TS_RATE
  	,DCO.TRATE S_TS_RATE
  	,BASE.TCOST B_TS_COST
  	,DCO.TCOST S_TS_COST
  	,BASE.XFER_RATE B_XFER_RATE
  	,DCO.XFER_RATE S_XFER_RATE
  	,BASE.XFER_COST B_XFER_COST
  	,DCO.XFER_COST S_XFER_COST
  	,BASE.PENALTY_COST B_PENALTY_COST
  	,DCO.PENALTY_COST S_PENALTY_COST
  	,BASE.TOTAL_COST B_TOTAL_COST
  	,DCO.TOTAL_COST S_TOTAL_COST
    ,BASE.TOTAL_COST - DCO.TOTAL_COST SAVINGS
  	,BASE.DCO_FROZEN_FLAG
--MODEL_RUN_PARAMETERS_FLAT
    ,MRP.MARKET_AREA PARAMETER_MARKET_AREA
    ,MRP.START_DATE PARAMETER_START_DATE
    ,MRP.END_DATE PARAMETER_END_DATE
    ,MRP.RANGE PARAMETER_RANGE
    ,MRP.USERID PARMAETER_USERID
    ,MRP.OPTIMIZE_EANDR_ONLY PARAMETER_OPTIMIZE_EANDR_ONLY
    ,MRP.RUN_DTM AS MODEL_RUN_DTM
FROM STG.ENO_GREENFLOW_SOLUTION_RESULTS BASE
JOIN STG.ENO_GREENFLOW_SOLUTION_RESULTS DCO
ON BASE.COLLECTION_POINT_ID = DCO.COLLECTION_POINT_ID
  AND BASE.ENO_ID =DCO.ENO_ID
  AND BASE.ENO_RESULTSOURCE = 'BASELINE'
  AND DCO.ENO_RESULTSOURCE = 'DCO'
LEFT JOIN MART.MODEL_RUN_PARAMETERS_FLAT MRP ON BASE.ENO_ID= MRP.ENO_ID
LEFT JOIN MART.MODEL_COLLECTION_POINTS_PERSISTENT MCP
ON MCP.ENO_ID = BASE.ENO_ID
  AND MCP.ROWNUMBER = BASE.COLLECTION_POINT_ID::BIGINT
LEFT JOIN MART.MODEL_FACILITIES_PERSISTENT MFP
ON MFP.ENO_ID = BASE.ENO_ID
  AND MFP.FAC_ID = BASE.DEPOT_FAC_ID
LEFT JOIN MART.MODEL_FACILITIES_PERSISTENT MFP2
ON MFP2.ENO_ID = BASE.ENO_ID
  AND MFP2.FAC_ID = BASE.DISP_FAC_ID
LEFT JOIN MART.MODEL_FACILITIES_PERSISTENT MFP3
ON MFP3.ENO_ID = DCO.ENO_ID
  AND MFP3.FAC_ID = DCO.DEPOT_FAC_ID
LEFT JOIN MART.MODEL_FACILITIES_PERSISTENT MFP4
ON MFP4.ENO_ID = DCO.ENO_ID
  AND MFP4.FAC_ID = DCO.DISP_FAC_ID
;
