-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** UI_PARMS
CREATE PROCEDURE UI_PARMS(START_DATE VARCHAR, END_DATE VARCHAR, MARKET_AREA VARCHAR, RANGE VARCHAR, LAMBDA VARCHAR, USERID VARCHAR, OPTIMIZE_EANDR_ONLY VARCHAR)
RETURNS VARCHAR(16777216)
LANGUAGE JAVASCRIPT
EXECUTE AS CALLER
AS '
var sql_command = "select MRP_SEQ_01.nextval"
var res = snowflake.execute( {sqlText: sql_command } );
res.next();
seq = res.getColumnValue(1);
var sql_command = "set start_date = " + "''" + START_DATE + "''";
var res = snowflake.execute( {sqlText: sql_command } );
var sql_command = "set end_date = " + "''" + END_DATE + "''";
var res = snowflake.execute( {sqlText: sql_command } );
var sql_command = "set MARKET_AREA = " + "''" + MARKET_AREA + "''";
var res = snowflake.execute( {sqlText: sql_command } );
var sql_command = "set RANGE = " + "''" + RANGE + "''";
var res = snowflake.execute( {sqlText: sql_command } );
var sql_command = "set LAMBDA = " + "''" + LAMBDA + "''";
var res = snowflake.execute( {sqlText: sql_command } );
var sql_command = "set USERID = " + "''" + USERID + "''";
var res = snowflake.execute( {sqlText: sql_command } );
var sql_command = "set num_weeks_3p = " + "''" + 13 + "''";
var res = snowflake.execute( {sqlText: sql_command } );
var sql_command = "set OPTIMIZE_EANDR_ONLY = " + "''" + OPTIMIZE_EANDR_ONLY + "''";
var res = snowflake.execute( {sqlText: sql_command } );

//Set Variable DAYS
var result1 = "SELECT COUNTDAYS($start_date,$end_date,0) as COUNTDAYS";
var res1 = snowflake.execute( {sqlText: result1 } );
res1.next();
COUNTDAYS = res1.getColumnValue(1);
var sql_command = "set DAYS =" + "''" + COUNTDAYS + "''";
var res = snowflake.execute( {sqlText: sql_command } );

if (LAMBDA == ''N'') {
//Set Varialble ENO_ID
var result = "SELECT $USERID||''_''||$MARKET_AREA||''_''||to_char(current_date,''YYYYMMDD'')||''_''||''" + seq +"'' as ENO_ID";
var res = snowflake.execute( {sqlText: result } );
res.next();
ENO_ID = res.getColumnValue(1);
var sql_command = "insert into MART.MODEL_RUN_PARAMETERS SELECT ''" + ENO_ID +"'' as ENO_ID,object_construct(''Start_Date:'', $start_date,''END_DATE:'',$end_date,''MARKET_AREA:'',$MARKET_AREA,''RANGE:'', $RANGE, ''LAMBDA:'', $LAMBDA, ''USERID:'', $USERID, ''OPTIMIZE_EANDR_ONLY:'', $OPTIMIZE_EANDR_ONLY) as PARAMETER_JSON,current_timestamp as timestamp_ltz,current_User as USER_NM";
var res = snowflake.execute( {sqlText: sql_command } );
var VALIDATION_SP = "CALL VALIDATION(''" + ENO_ID +"'')";
var res = snowflake.execute( {sqlText: VALIDATION_SP } );
return ENO_ID;};
if (LAMBDA == ''Y'') {
var sql_command = "CREATE OR REPLACE /* SqlDBM hack  TEMPORARY */ TABLE MODEL_COLLECTION_POINTS AS SELECT * FROM MODEL_COLLECTION_POINTS;";
var res = snowflake.execute( {sqlText: sql_command } );
var sql_command = "CREATE OR REPLACE /* SqlDBM hack  TEMPORARY */ TABLE MODEL_FACILITIES AS SELECT * FROM MODEL_FACILITIES;";
var res = snowflake.execute( {sqlText: sql_command } );
var sql_command = "CREATE OR REPLACE /* SqlDBM hack  TEMPORARY */ TABLE PRE_MODEL_FACILITIES_MATERIAL AS SELECT * FROM PRE_MODEL_FACILITIES_MATERIAL;";
var res = snowflake.execute( {sqlText: sql_command } );
};
if (LAMBDA == ''P'') {
var sql_command = "SELECT 1;";
var res = snowflake.execute( {sqlText: sql_command } );
};
return 1;
';
