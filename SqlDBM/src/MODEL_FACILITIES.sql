-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** MODEL_FACILITIES
CREATE VIEW MODEL_FACILITIES as
with THIRD_PARTY_TOTAL_TONNAGE AS (
SELECT dispfacid, COALESCE(sum(tons),0) as tons_3p
FROM MODEL_COLLECTION_POINTS where depotfacid='3PDEPOT'
GROUP BY dispfacid
)
select  fac_id,
        fac_name,
        fac_type,
        address_1,
        address_2,
        GEO_CITY_NM,
        GEO_COUNTY_NM,
        GEO_STATE_CD,
        GEO_ZIP_CD,
        latitude,
        longitude,
        nvl(turn_time, 20)  as turn_time,
        nvl(min_tons, 0)      as min_tons,
        case when max_tons is null or max_tons = 0 then 999999999 else GREAtest(max_tons,COALESCE(third_party.tons_3p,0)) end as max_tons,
        nvl(fixed_cost, 0) as fixed_cost ,
        wm_owned_flag ,
        status_ind,
        FAC_SHORT_NM
from PRE_MODEL_FACILITIES
LEFT JOIN THIRD_PARTY_TOTAL_TONNAGE third_party ON PRE_MODEL_FACILITIES.FAC_ID=third_party.DISPFACID;
