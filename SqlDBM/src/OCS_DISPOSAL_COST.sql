-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** OCS_DISPOSAL_COST
CREATE VIEW OCS_DISPOSAL_COST AS

SELECT

  SUBSTRING(DispFacID,1,6) as FAC_ID,

  SUBSTRING(DispFacID,8) as FAC_TYPE,

  WASTE_TYPE,

  AVG(COST/ TONS) AS DISPOSAL_COST

FROM

(

  select 1 as SRC, DispFacID, WASTE_TYPE, COST, TONS, INACTIVE, SERVICE_DT, INTERCOMPANY from MART.COMRES_FACT

  UNION ALL

  select 2, DispFacID, WASTE_TYPE, COST, TONS, INACTIVE, SERVICE_DT, INTERCOMPANY from MART.ROLLOFF_FACT

)

WHERE (INACTIVE IS NULL OR     INACTIVE     = '')	-- currently stored as empty string

AND   (INTERCOMPANY IS NULL OR INTERCOMPANY = '')	-- currently stored as empty string

AND COST IS NOT NULL

AND TONS IS NOT NULL

AND TONS > 0 AND FAC_ID iS NOT NULL

AND SERVICE_DT  >= current_Date - 90

AND waste_type IN ( 'MSW', 'C&D', 'SPW' )

GROUP BY 1,2,3;
