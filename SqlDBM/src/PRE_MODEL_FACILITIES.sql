-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** PRE_MODEL_FACILITIES
CREATE VIEW PRE_MODEL_FACILITIES AS
select t1.fac_id,
        coalesce(t2.fac_name, t3.fac_name) as fac_name,
        case when t2.fac_id is not null then 'Collection' else substring(t3.fac_id,8) end as fac_type,
        coalesce (t2.address_1, t3.address_1) as address_1,
        coalesce (t2.address_2, t3.address_2) as address_2,
        coalesce (t2.GEO_CITY_NM, t3.GEO_CITY_NM) as GEO_CITY_NM,
        coalesce (t2.GEO_COUNTY_NM, t3.GEO_COUNTY_NM) as GEO_COUNTY_NM,
        coalesce (t2.GEO_STATE_CD, t3.GEO_STATE_CD) as GEO_STATE_CD,
        coalesce (t2.GEO_ZIP_CD, t3.GEO_ZIP_CD) as GEO_ZIP_CD,
        coalesce (t2.latitude, t3.latitude) as latitude,
        coalesce (t2.longitude, t3.longitude) as longitude,
        t4.cycle_minute_cnt as turn_time,
        gc.min_tons_governing_scaled as MIN_TONS,
        gc.max_tons_governing_scaled as MAX_TONS,
        fixed_cost as fixed_cost ,
        coalesce (t2.wm_owned_flag, t3.wm_owned_flag) as wm_owned_flag,
        coalesce (t2.active_flag, t3.active_flag) as status_ind,
        COALESCE(T2.FAC_SHORT_NM,T3.FAC_SHORT_NM) AS FAC_SHORT_NM
from MODEL_FACILITY_LIST t1 left join HAULING_SITE t2 on t1.fac_id = t2.fac_id||'_Depot'
                            left join DISPOSAL_SITE t3 on t1.fac_id = t3.fac_id
                            LEFT JOIN MODEL_GOVERNING_CONSTRAINTS gc ON t1.FAC_ID=gc.FAC_ID AND gc.SRC='GLOBAL_FACILITY_CONSTRAINT'
                            LEFT JOIN (SELECT FAC_ID, AVG(CYCLE_MINUTE_CNT) AS CYCLE_MINUTE_CNT FROM DISPOSAL_SITE_LOB GROUP BY FAC_ID) t4 ON t1.FAC_ID = t4.FAC_ID
WHERE t1.FAC_ID != '3PDEPOT'
UNION ALL
select '3PDEPOT' as fac_id,             -- Dummy depot for 3rd party
       '3rd Party Depot' as fac_name,
       'Collection' as fac_type,
       null as address_1,
       null as address_2,
       NULL AS GEO_CITY_NM,
       NULL AS GEO_COUNTY_NM,
       NULL AS GEO_STATE_CD,
       NULL AS GEO_ZIP_CD,
       39.828 as latitude,              -- Center of US
      -98.5696 as longitude,
       20 as turn_time,
       0   as min_tons,
       999999 as max_tons,
       0 as fixed_cost ,
       'N' as wm_owned_flag ,
       'A' as status_ind ,
       '3PDEPOT' AS FAC_SHORT_NM;
