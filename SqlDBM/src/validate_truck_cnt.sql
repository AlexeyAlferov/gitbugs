-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** validate_truck_cnt
CREATE VIEW validate_truck_cnt AS (

SELECT

    hsc.fac_id

    , hsc.sublob

    , hsc.truck_cnt

    , vh.true_truck_cnt

    , last_updated_dtm

    , last_updated_user

FROM HAULING_SITE_capacity hsc

INNER JOIN

  (SELECT HAULING_SITE, sublob, service_dt, COUNT(DISTINCT vehicle_id) AS true_truck_cnt

      FROM co_events

      WHERE service_dt BETWEEN $start_date AND $end_date

      GROUP BY HAULING_SITE, sublob, service_dt

   ) vh

    ON hsc.fac_id = vh.HAULING_SITE AND hsc.sublob = vh.sublob

WHERE truck_cnt < true_truck_cnt

);
