-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** ROLLOFF_DISPOSAL_LEG_TIME
CREATE VIEW ROLLOFF_DISPOSAL_LEG_TIME as (SELECT 
  "LANDFILL_PKEY", 
  "NET_TRAVEL_TO_DSPS" 
FROM (SELECT 
ROL.PKEY LANDFILL_PKEY,  
sum(CASE when TLT.UNIQUEID IN ('E/R','BTE','BRN') OR TLT.UNIQUEID IN ('S/O','DNR','LIV') THEN
	 CASE WHEN  STOPTICKET BETWEEN DEPARTCUSTOMER and ARRIVELANDFILL and RESTARTTICKET BETWEEN DEPARTCUSTOMER and ARRIVELANDFILL
	 	  THEN  ( TIMESTAMPDIFF(MINUTE , DEPARTCUSTOMER , ARRIVELANDFILL ) - TIMESTAMPDIFF(MINUTE , STOPTICKET, RESTARTTICKET) - NVL(TIMESTAMPDIFF(MINUTE , RODDCARL.DOWNSTART, RODDCARL.DOWNEND),0)) 
	 ELSE  TIMESTAMPDIFF(MINUTE ,DEPARTCUSTOMER , ARRIVELANDFILL) - NVL(TIMESTAMPDIFF(MINUTE , RODDCARL.DOWNSTART, RODDCARL.DOWNEND),0)
	 END
	 WHEN  TLT.UNIQUEID IN ('FFY','FDR','FRN') OR TLT.UNIQUEID IN ('FYN','FYS') THEN
       CASE WHEN STOPTICKET BETWEEN DISPATCHED AND ARRIVELANDFILL AND RESTARTTICKET BETWEEN DISPATCHED AND ARRIVELANDFILL
			THEN  ( TIMESTAMPDIFF (MINUTE , DISPATCHED, ARRIVELANDFILL) - TIMESTAMPDIFF(MINUTE ,STOPTICKET, RESTARTTICKET)  - NVL(TIMESTAMPDIFF(MINUTE , RODTSARL.DOWNSTART, RODTSARL.DOWNEND),0))
		ELSE   TIMESTAMPDIFF(MINUTE,DISPATCHED,  ARRIVELANDFILL) - NVL(TIMESTAMPDIFF(MINUTE , RODTSARL.DOWNSTART, RODTSARL.DOWNEND),0)
		END
END)  NET_TRAVEL_TO_DSPS
FROM  DEV_OCS.ODS.TP_CO_RESULT COR
JOIN  DEV_OCS.ODS.TP_CUSTOMERORDER CO
ON COR.FK_CUSTOMERORDER = CO.PKEY
AND COR.FK_VEHICLE IS NULL
JOIN  DEV_OCS.ODS.TP_LOB L
ON L.PKEY = CO.FK_LOB
AND L.UNIQUEID = 'O'
JOIN DEV_OCS.ODS.TP_TICKETLOADTYPE TLT 
ON TLT.PKEY = cor.fk_loadtype 
JOIN DEV_OCS.ODS.TP_RO_LANDFILL ROL 
ON ROL.FK_CUSTOMERORDER =  CO.PKEY
AND ROL.FK_VEHICLE IS NULL
LEFT JOIN DEV_OCS.ODS.TP_RO_DOWNTIME RODDCARL
ON RODDCARL.FK_ROUTEORDER = CO.FK_ROUTEORDER
AND RODDCARL.FK_VEHICLE IS NULL
AND TLT.UNIQUEID IN ('E/R','BTE','BRN','S/O','DNR','LIV')
AND RODDCARL.DOWNSTART BETWEEN COR.DEPARTCUSTOMER AND COR.ARRIVELANDFILL
AND RODDCARL.DOWNEND BETWEEN COR.DEPARTCUSTOMER AND COR.ARRIVELANDFILL
AND NOT (
		 RODDCARL.DOWNSTART BETWEEN COR.STOPTICKET AND COR.RESTARTTICKET
		AND RODDCARL.DOWNEND BETWEEN COR.STOPTICKET AND COR.RESTARTTICKET
 
        )
        
LEFT JOIN DEV_OCS.ODS.TP_RO_DOWNTIME RODTSARL ON RODTSARL.FK_ROUTEORDER = CO.FK_ROUTEORDER
AND RODTSARL.FK_VEHICLE IS NULL
AND  TLT.UNIQUEID IN ('FFY','FDR','FRN','FYN','FYS')
AND RODTSARL.DOWNSTART BETWEEN COR.DISPATCHED AND COR.ARRIVELANDFILL
AND RODTSARL.DOWNEND BETWEEN COR.DISPATCHED AND COR.ARRIVELANDFILL
AND NOT (
		 RODTSARL.DOWNSTART BETWEEN COR.STOPTICKET AND COR.RESTARTTICKET
		AND RODTSARL.DOWNEND BETWEEN COR.STOPTICKET AND COR.RESTARTTICKET
 
        )
group by ROL.PKEY
) AS "v_0000017686_0000143661");
