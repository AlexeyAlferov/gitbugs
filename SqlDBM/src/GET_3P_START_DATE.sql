-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** GET_3P_START_DATE
CREATE FUNCTION GET_3P_START_DATE(NUM_WEEKS_3P FLOAT, START_DATE DATE, END_DATE DATE, END_DATE_3P DATE)
RETURNS DATE
LANGUAGE JAVASCRIPT
IMMUTABLE
COMMENT='Get min dates for calculating 3P averages for PMT_LANDFILLS and PMT_TRANSFERS'
AS '
    // TODO: validation on min_start_date within this function
    // Get num weeks in end_date - start_date
    var extant_weeks = Math.round((END_DATE - START_DATE) / 1000 / 60 / 60 / 24 / 7);

    if(extant_weeks > NUM_WEEKS_3P) {
    // If there''s more data available than requested, right-align the window we''ll use
        var start_3p = END_DATE;
        var week_diff = NUM_WEEKS_3P * 7;
    } else {
    // the week_diff is the remaining amount of padding inferrable from end_date_3p
        var start_3p = START_DATE;
        var forward_padding = (END_DATE_3P - END_DATE) / 1000 / 60 / 60 / 24 / 7;
        var week_diff = (NUM_WEEKS_3P - extant_weeks) - forward_padding;
    }
    start_3p.setDate(start_3p.getDate() - week_diff * 7);

    // Finally, ensure start_date is a Sunday
    start_3p.setDate(start_3p.getDate() - start_3p.getDay());
    return start_3p;
';
