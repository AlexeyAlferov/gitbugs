-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** BMT_LOCATION_MATCHING
CREATE VIEW BMT_LOCATION_MATCHING as

select * from

(select

HAULING_SITE_ID,

OCS_DISPOSAL_CD,

OCS_DISPOSAL_NM,

DISPOSAL_SITE_ID ||'_' ||case when DISPOSAL_SITE_TYPE = 'Transfer Station' then 'TS'

                when DISPOSAL_SITE_TYPE = 'MRF Recycling' then 'MRF'

                else DISPOSAL_SITE_TYPE end as MATCHED_LOCATIONID_TYPE,

LAST_UPDATED_DTM ,

LAST_UPDATED_USER ,

DATA_COLLCTION_ADD_DELETE_UPDATE ,

row_number() over (partition by HAULING_SITE_ID, OCS_DISPOSAL_CD order by last_updated_dtm desc nulls last) as rnk,

CASE WHEN DISPOSAL_SITE_ID IS NULL OR DISPOSAL_SITE_ID ='' THEN 'N' ELSE 'Y' END AS OCS_CD_ASSIGNED

 from STG.FACILITY_MATCHING_DATA_BMT_DATA_COLLCTN

 )  where rnk=1 AND OCS_CD_ASSIGNED ='Y';
