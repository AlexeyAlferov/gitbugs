-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** VALIDATION_DATA_COMPLETENESS_MODEL_COLL_PTS_BAD_FAC_ID
CREATE VIEW VALIDATION_DATA_COMPLETENESS_MODEL_COLL_PTS_BAD_FAC_ID AS
SELECT
    CP.OCS_DISPOSAL_CD
    ,CP.DEPOTFACID AS DEPOTFACID
    ,COUNT(*) AS TOTAL_RECORDS
    ,SUM(CP.TONS) AS TOTAL_TONS
    ,'Hauling site ' || CP.DEPOTFACID || ' with OCS_DISPOSAL_CODE ' || NVL(CP.OCS_DISPOSAL_CD, '') ||
        ' maps to ' || NVL(MAX(CP.DISPFACID),'') ||
        ' but that facility is not the facilities list.  It accounts for '|| CAST(TOTAL_RECORDS AS STRING) ||
        ' collection points and ' || CAST(TOTAL_TONS AS STRING)||' Tons' AS DETAIL
	,SUBSTR(CP.DEPOTFACID,1,6) AS LH_PARM_1
    ,'COLLECTION'  AS LH_PARM_2
    ,CP.OCS_DISPOSAL_CD AS LH_PARM_3
    ,NULL AS LH_PARM_4
    ,NULL AS LH_PARM_5  
FROM MODEL_COLLECTION_POINTS CP
LEFT JOIN MODEL_FACILITIES FAC
    on FAC.FAC_ID = CP.DISPFACID
WHERE CP.DISPFACID IS NOT NULL
    and FAC.FAC_ID IS NULL
GROUP BY CP.DEPOTFACID, CP.OCS_DISPOSAL_CD
;
