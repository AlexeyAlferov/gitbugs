-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** VALIDATION_DATA_HRS_CAP_ACTIVE_FACILITIES
CREATE VIEW VALIDATION_DATA_HRS_CAP_ACTIVE_FACILITIES AS
SELECT HC.FAC_ID as model_hrs_cap_DEPOT
      , MP.TOTAL_TONS AS TOTAL_TONS
      ,'Hauling site '||HC.FAC_ID|| ', is inactive.  It accounts for '||MP.TOTAL_RECORDS|| ' collection points and  ' ||MP.TOTAL_TONS||' tons' AS DETAIL
	  ,SUBSTR(HC.FAC_ID,1,6) AS LH_PARM_1
	  ,'COLLECTION'  AS LH_PARM_2
      ,NULL AS LH_PARM_3
	  ,NULL AS LH_PARM_4
	  ,NULL AS LH_PARM_5
     FROM (select distinct FAC_ID from model_hrs_cap) HC
LEFT JOIN HAULING_SITE HS ON HS.FAC_ID||'_Depot'=HC.FAC_ID
LEFT JOIN
(
  SELECT DEPOTFACID
        ,COUNT(*) AS TOTAL_RECORDS
        ,SUM(TONS) AS TOTAL_TONS
  FROM MODEL_COLLECTION_POINTS
  GROUP BY DEPOTFACID
)MP ON HC.FAC_ID = MP.DEPOTFACID
WHERE HS.FAC_ID IS NULL OR UPPER(HS.ACTIVE_FLAG) != 'A'
;
