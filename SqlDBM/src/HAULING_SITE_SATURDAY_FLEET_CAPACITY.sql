-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** HAULING_SITE_SATURDAY_FLEET_CAPACITY
CREATE VIEW HAULING_SITE_SATURDAY_FLEET_CAPACITY as (SELECT 
  "FAC_ID", 
  "SUBLOB", 
  "WEEK_DAY_CAPACITY", 
  "SATURDAY_CAPACITY", 
  "PERCENTAGE_HOURS_ON_SAT" 
FROM (with WEEKDAYS_SATURDAYS_CNT_IN_YEAR AS
(
SELECT SUM(CASE WHEN dayname(CALNDR_DT) IN ('Mon', 'Tue', 'Wed', 'Thu', 'Fri') THEN 1 ELSE 0 END) WEEK_DAYS,
       SUM(CASE WHEN dayname(CALNDR_DT) IN ('Sat') THEN 1 ELSE 0 END) SAT_DAYS
from DEV_ONEWM.STG.DIM_DT_CALNDR_DAY 
where CALNDR_DT between current_date - 366 and current_date - 1
)

SELECT RO_Leave_Yard.HAULING_SITE FAC_ID,  RO_Leave_Yard.sublob,
SUM  (CASE WHEN dayname(RO_Leave_Yard.service_dt) IN ('Mon', 'Tue', 'Wed', 'Thu', 'Fri')
     THEN (DATEDIFF(MINUTE , RO_Leave_Yard.event_start , RO_Arrive_Yard.event_start))
     END)/(select WEEK_DAYS from WEEKDAYS_SATURDAYS_CNT_IN_YEAR)
     WEEK_DAY_CAPACITY ,
SUM  (CASE WHEN dayname(RO_Leave_Yard.service_dt) IN ('Sat')
     THEN (DATEDIFF(MINUTE , RO_Leave_Yard.event_start , RO_Arrive_Yard.event_start))
     END)/(select SAT_DAYS from WEEKDAYS_SATURDAYS_CNT_IN_YEAR)
     SATURDAY_CAPACITY ,
    ((SATURDAY_CAPACITY/NULLIF(WEEK_DAY_CAPACITY,0))*100) PERCENTAGE_HOURS_ON_SAT
FROM DEV_ONEWM.MART.co_events RO_Leave_Yard
join DEV_ONEWM.MART.co_events RO_Arrive_Yard
on RO_Leave_Yard.ro_key = RO_Arrive_Yard.ro_key
and RO_Leave_Yard.event_type = 'Leave Yard'
and RO_Arrive_Yard.event_type = 'Arrive Yard'
WHERE RO_Leave_Yard.service_dt between  current_date - 366 and current_date -1 
group by RO_Leave_Yard.HAULING_SITE, RO_Leave_Yard.sublob
) AS "v_0000017686_0000143927");
