-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** VALIDATION_DATA_PRE_MODEL_NO_TURN_TIME
CREATE VIEW VALIDATION_DATA_PRE_MODEL_NO_TURN_TIME AS
SELECT
     PMF.FAC_ID, TOTAL_TONS, PMF.TURN_TIME,
     'Turn time not supplied for Facility '||PMF.FAC_ID||'. A substitute turn time of '||round(MF.TURN_TIME,2)||' was applied.'||
     CASE WHEN TOTAL_RECORDS IS NULL THEN ' Facility and waste type have no collection points  ' ELSE
      ' Facility and waste type accounts for '||TOTAL_RECORDS ||' Collection Points and '||round(TOTAL_TONS,2)||' Tons' END AS DETAIL
	,SUBSTR(PMF.FAC_ID,1,6) AS LH_PARM_1
	,LH_FAC_TYPE(PMF.FAC_ID)  AS LH_PARM_2
	,NULL AS LH_PARM_3
	,NULL AS LH_PARM_4
	,NULL AS LH_PARM_5
FROM PRE_MODEL_FACILITIES PMF
LEFT JOIN (
  SELECT MCP.DISPFACID as DISPFACID
    	,COUNT(*) AS TOTAL_RECORDS
    	,SUM(TONS) AS TOTAL_TONS
  FROM MODEL_COLLECTION_POINTS MCP
  GROUP BY DISPFACID
) MP ON PMF.FAC_ID = MP.DISPFACID
INNER JOIN MODEL_FACILITIES MF ON MF.FAC_ID = PMF.FAC_ID
WHERE PMF.TURN_TIME IS NULL
;
