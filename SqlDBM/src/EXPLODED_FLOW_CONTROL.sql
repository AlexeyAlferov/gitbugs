-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** EXPLODED_FLOW_CONTROL
CREATE VIEW EXPLODED_FLOW_CONTROL AS
SELECT
    agg_fc.FC_RULE_NUMBER
    ,agg_fc.RULE_SOURCE
    ,agg_fc.METHOD_TYPE
    ,agg_fc.METHOD_TYPE_DESC
    ,agg_fc.LOB
    ,agg_fc.WASTE_TYPE
    ,agg_fc.COLLECTION_ENTITY
    ,agg_fc.MIN_TONS -- note scaled tons
    ,agg_fc.MAX_TONS -- note scaled tons
    ,detailed_fc.PKEY
    ,detailed_fc.DEST_COUNTY_NM
    ,detailed_fc.DEST_CITY_NM
    ,detailed_fc.DEST_DISPOSAL_SITE_ID
    ,detailed_fc.DEST_STATE_CD							-- add State as a destination
    ,detailed_fc.CUSTOMER_NM
    ,TRIM(GET(SPLIT(detailed_fc.RULE_TYPE,'-'),1)) AS RULE_DEST
    ,agg_fc.DISPOSAL_ENTITY as DISPOSAL_ENTITY
FROM MODEL_FLOW_CONTROL_RULES agg_fc
LEFT JOIN FLOW_CONTROL detailed_fc ON
    agg_fc.RULE_SOURCE = TRIM(GET(SPLIT(detailed_fc.RULE_TYPE,'-'),0)) AND
    agg_fc.METHOD_TYPE_DESC=detailed_fc.METHOD_TYPE AND --confusingly aliased METHOD_TYPE field in agg flow control
    agg_fc.LOB=detailed_fc.LOB AND
    agg_fc.WASTE_TYPE=detailed_fc.WASTE_TYPE AND
    COALESCE(agg_fc.MIN_TONS_UNSCALED,0) = COALESCE(detailed_fc.MIN_TONS,0) AND --join on unscaled tons
    COALESCE(agg_fc.MAX_TONS_UNSCALED,0) = COALESCE(detailed_fc.MAX_TONS,0) AND --join on unscaled tons
    (agg_fc.COLLECTION_ENTITY=UPPER(detailed_fc.SRC_STATE_CD||'-'||detailed_fc.SRC_CITY_NM) OR
    agg_fc.COLLECTION_ENTITY= UPPER(detailed_fc.SRC_STATE_CD||'-'||detailed_fc.SRC_COUNTY_NM) OR
    agg_fc.COLLECTION_ENTITY=UPPER(detailed_fc.SRC_HAULING_SITE_ID) OR
    agg_fc.COLLECTION_ENTITY=UPPER(detailed_fc.SRC_CUSTOMER_NM) OR
    agg_fc.COLLECTION_ENTITY=UPPER(detailed_fc.SRC_STATE_CD) OR
    agg_fc.COLLECTION_ENTITY=UPPER(detailed_fc.SRC_HAULING_SITE_ID||'-'||detailed_fc.SRC_OCS_DISPOSAL_CD))  -- OCS join
 WHERE agg_fc.METHOD_TYPE!=5 AND detailed_fc.ACTIVE_FLAG='A'
;
