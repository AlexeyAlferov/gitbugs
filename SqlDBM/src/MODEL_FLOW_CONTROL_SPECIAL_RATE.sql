-- ***************************** SqlDBM: Snowflake ****************************
-- * Generated by SqlDBM: MART SCHEMA, v18 by lesya.rylova+standard@gmail.com *


-- ************************************** MODEL_FLOW_CONTROL_SPECIAL_RATE
CREATE VIEW MODEL_FLOW_CONTROL_SPECIAL_RATE AS



-- STEP 1:  SELECT ONLY SPECIAL RATE FLOW CONTROL RULES

WITH SPECIAL_RATE_RULES AS

(SELECT MFC.*

       ,FC.DEST_COUNTY_NM

       ,FC.DEST_CITY_NM

       ,FC.DEST_STATE_CD

       ,FC.DEST_DISPOSAL_SITE_ID

       ,TRIM(GET(SPLIT(FC.RULE_TYPE,'-'),1)) AS RULE_DEST

 FROM MODEL_FLOW_CONTROL_RULES MFC

 INNER JOIN FLOW_CONTROL FC ON MFC.MIN_FC_PKEY = FC.PKEY AND ACTIVE_FLAG = 'A'

 WHERE MFC.METHOD_TYPE = 5), --Special rate only rules



-- STEP 2:  DIVIDE UP SPECIAL RATE RULES BY RULE_SOURCE (State, County, City, Site, Customer)

-- GET all state-level rules for special rate

SOURCE_STATE_FLOW_CONTROL AS

(SELECT *

 FROM SPECIAL_RATE_RULES

 WHERE RULE_SOURCE='State'),



-- GET all county-level rules for special rate

SOURCE_COUNTY_FLOW_CONTROL AS

(SELECT *

 FROM SPECIAL_RATE_RULES

 WHERE RULE_SOURCE='County'),



-- GET all city-level rules for special rate

SOURCE_CITY_FLOW_CONTROL AS

(SELECT *

 FROM SPECIAL_RATE_RULES

 WHERE RULE_SOURCE='City'),



-- GET all site-level rules for special rate

SOURCE_HAULING_SITE_FLOW_CONTROL AS

(SELECT *

 FROM SPECIAL_RATE_RULES

 WHERE RULE_SOURCE='Hauling Site'),



-- GET all hauling site - OCS level rules for special rate

SOURCE_OCS_DISPOSAL_FLOW_CONTROL AS

(SELECT *

 FROM SPECIAL_RATE_RULES

 WHERE RULE_SOURCE='OCS Code'),





--Create the table for all [x level]-sourced flow controls and associated collection points

FC_SPECIAL_RATE_COLLECTION AS

(

 SELECT fc.FC_RULE_NUMBER

       ,cp.ROWNUMBER

 FROM SOURCE_STATE_FLOW_CONTROL fc

 INNER JOIN MODEL_COLLECTION_POINTS cp ON UPPER(cp.GEO_STATE_CD)=UPPER(fc.COLLECTION_ENTITY)

WHERE ((fc.LOB=cp.LOB and fc.WASTE_TYPE=cp.WASTE_TYPE) or

      (UPPER(fc.LOB)='ALL LOBS' AND fc.WASTE_TYPE=cp.WASTE_TYPE) OR

      (fc.LOB=cp.LOB and UPPER(fc.WASTE_TYPE)='ALL') OR

      (UPPER(fc.LOB)='ALL LOBS' AND UPPER(fc.WASTE_TYPE)='ALL'))



 UNION



 SELECT fc.FC_RULE_NUMBER

       ,cp.ROWNUMBER

 FROM SOURCE_COUNTY_FLOW_CONTROL fc

 INNER JOIN MODEL_COLLECTION_POINTS cp ON UPPER(cp.GEO_STATE_CD||'-'||cp.GEO_COUNTY_NM)=UPPER(fc.COLLECTION_ENTITY)

WHERE ((fc.LOB=cp.LOB and fc.WASTE_TYPE=cp.WASTE_TYPE) or

      (UPPER(fc.LOB)='ALL LOBS' AND fc.WASTE_TYPE=cp.WASTE_TYPE) OR

      (fc.LOB=cp.LOB and UPPER(fc.WASTE_TYPE)='ALL') OR

      (UPPER(fc.LOB)='ALL LOBS' AND UPPER(fc.WASTE_TYPE)='ALL'))



 UNION



 SELECT fc.FC_RULE_NUMBER

       ,cp.ROWNUMBER

 FROM SOURCE_CITY_FLOW_CONTROL fc

 INNER JOIN MODEL_COLLECTION_POINTS cp ON UPPER(CP.GEO_STATE_CD||'-'||cp.GEO_CITY_NM)=UPPER(fc.COLLECTION_ENTITY)

WHERE ((fc.LOB=cp.LOB and fc.WASTE_TYPE=cp.WASTE_TYPE) or

      (UPPER(fc.LOB)='ALL LOBS' AND fc.WASTE_TYPE=cp.WASTE_TYPE) OR

      (fc.LOB=cp.LOB and UPPER(fc.WASTE_TYPE)='ALL') OR

      (UPPER(fc.LOB)='ALL LOBS' AND UPPER(fc.WASTE_TYPE)='ALL'))



 UNION



 SELECT fc.FC_RULE_NUMBER

       ,cp.ROWNUMBER

 FROM SOURCE_HAULING_SITE_FLOW_CONTROL fc

 INNER JOIN MODEL_COLLECTION_POINTS cp ON UPPER(cp.DEPOTFACID)=UPPER(fc.COLLECTION_ENTITY||'_DEPOT')

WHERE ((fc.LOB=cp.LOB and fc.WASTE_TYPE=cp.WASTE_TYPE) or

      (UPPER(fc.LOB)='ALL LOBS' AND fc.WASTE_TYPE=cp.WASTE_TYPE) OR

      (fc.LOB=cp.LOB and UPPER(fc.WASTE_TYPE)='ALL') OR

      (UPPER(fc.LOB)='ALL LOBS' AND UPPER(fc.WASTE_TYPE)='ALL'))



 UNION

 --

 -- Again we are joining on the Depot and the OCS Codes - CONTAINS handles the case where we have multiple - e.g ABC, DEF

 SELECT fc.FC_RULE_NUMBER

       ,cp.ROWNUMBER

 FROM SOURCE_OCS_DISPOSAL_FLOW_CONTROL fc

 INNER JOIN MODEL_COLLECTION_POINTS cp ON UPPER(cp.DEPOTFACID)=UPPER(GET(SPLIT(fc.COLLECTION_ENTITY,'-'),0)||'_DEPOT') AND

  										  CONTAINS( UPPER(CP.OCS_DISPOSAL_CD) , UPPER(GET(SPLIT(fc.COLLECTION_ENTITY,'-'),1) ))

WHERE ((fc.LOB=cp.LOB and fc.WASTE_TYPE=cp.WASTE_TYPE) or

      (UPPER(fc.LOB)='ALL LOBS' AND fc.WASTE_TYPE=cp.WASTE_TYPE) OR

      (fc.LOB=cp.LOB and UPPER(fc.WASTE_TYPE)='ALL') OR

      (UPPER(fc.LOB)='ALL LOBS' AND UPPER(fc.WASTE_TYPE)='ALL'))

),



-- STEP 4:  DIVIDE UP SPECIAL RATE RULES BY DESTINATION SOURCE-TYPE

--STATE-specific flow controls

DEST_STATE_FLOW_CONTROL AS

(SELECT *

 FROM SPECIAL_RATE_RULES

 WHERE RULE_DEST = 'State'

), -- i.e., where state but no other destinations have been specified



--COUNTY-specific flow controls

DEST_COUNTY_FLOW_CONTROL AS

(SELECT *

 FROM SPECIAL_RATE_RULES

 WHERE RULE_DEST = 'County'),



--CITY-specific flow controls

DEST_CITY_FLOW_CONTROL AS

(SELECT *

 FROM SPECIAL_RATE_RULES

 WHERE RULE_DEST = 'City'),



--SITE-specific flow controls

DEST_SITE_FLOW_CONTROL AS

(SELECT SRR.*

 FROM SPECIAL_RATE_RULES SRR

 WHERE RULE_DEST = 'Disposal Site'),

-- INNER JOIN DISPOSAL_SITE DS ON DS.FAC_ID = SRR.DEST_DISPOSAL_SITE_ID),



-- STEP 5: GET ALL DISPOSAL SITES BY FLOW CONTROL RULE

 MODEL_DISPOSAL_FACILITIES_MAT_GEO AS

 (

 SELECT

 fac.FAC_ID,

 facm.WASTE_TYPE,

 fac.GEO_CITY_NM,

 fac.GEO_COUNTY_NM,

 fac.GEO_STATE_CD,

 fac.WM_OWNED_FLAG

 FROM MODEL_FACILITIES_MATERIAL facm

 LEFT join MODEL_FACILITIES fac ON fac.FAC_ID = facm.FAC_ID

 WHERE facm.ACCEPTED_FLAG in ('Y','U')

 ),

--Disposal sites by Flow control ID for special rates

FC_SPECIAL_RATE_DISPOSAL_SITES AS

(

 SELECT FC.FC_RULE_NUMBER,

        FAC.FAC_ID,

        FAC.WM_OWNED_FLAG

 FROM DEST_STATE_FLOW_CONTROL FC

 INNER JOIN MODEL_DISPOSAL_FACILITIES_MAT_GEO fac ON UPPER(fac.GEO_STATE_CD)=UPPER(fc.DEST_STATE_CD)

 WHERE (fc.WASTE_TYPE=fac.WASTE_TYPE) or (UPPER(fc.WASTE_TYPE)='ALL')





 UNION



SELECT

    FC.FC_RULE_NUMBER,

        FAC.FAC_ID,

        FAC.WM_OWNED_FLAG

FROM DEST_COUNTY_FLOW_CONTROL fc

INNER JOIN MODEL_DISPOSAL_FACILITIES_MAT_GEO fac ON UPPER(FAC.GEO_STATE_CD||'-'||FAC.GEO_COUNTY_NM) = UPPER(FC.DEST_STATE_CD||'-'||FC.DEST_COUNTY_NM)

WHERE (fc.WASTE_TYPE=fac.WASTE_TYPE) or (UPPER(fc.WASTE_TYPE)='ALL')



 UNION



SELECT

    FC.FC_RULE_NUMBER,

        FAC.FAC_ID,

        FAC.WM_OWNED_FLAG

FROM DEST_CITY_FLOW_CONTROL fc

INNER JOIN MODEL_DISPOSAL_FACILITIES_MAT_GEO fac ON UPPER(FAC.GEO_STATE_CD||'-'||FAC.GEO_CITY_NM) = UPPER(FC.DEST_STATE_CD||'-'||FC.DEST_CITY_NM)

WHERE (fc.WASTE_TYPE=fac.WASTE_TYPE) or (UPPER(fc.WASTE_TYPE)='ALL')



 UNION



SELECT

    FC.FC_RULE_NUMBER,

        FAC.FAC_ID,

        FAC.WM_OWNED_FLAG

FROM DEST_SITE_FLOW_CONTROL fc

INNER JOIN MODEL_DISPOSAL_FACILITIES_MAT_GEO fac ON fac.FAC_ID=fc.DEST_DISPOSAL_SITE_ID

WHERE (fc.WASTE_TYPE=fac.WASTE_TYPE) or (UPPER(fc.WASTE_TYPE)='ALL')

)



-- STEP 6:  CROSS PRODUCT:  By Flow Control Rule, output all combinations of

--          collection points and disposal sites selected above



SELECT CP.FC_RULE_NUMBER

      ,CP.ROWNUMBER

      ,DS.FAC_ID

      ,CASE WHEN DS.WM_OWNED_FLAG='Y' THEN FC.SPECIAL_RATE_AMT ELSE 0 END AS UNIT_COST

      ,CASE WHEN DS.WM_OWNED_FLAG='Y' THEN 0.0 ELSE FC.SPECIAL_RATE_AMT END AS UNIT_PRICE

      ,0 AS UNIT_REVENUE

FROM SPECIAL_RATE_RULES FC

  INNER JOIN FC_SPECIAL_RATE_COLLECTION CP ON CP.FC_RULE_NUMBER = FC.FC_RULE_NUMBER

  INNER JOIN FC_SPECIAL_RATE_DISPOSAL_SITES DS ON DS.FC_RULE_NUMBER = FC.FC_RULE_NUMBER

;
